!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).Nestled={})}(this,(function(t){"use strict";function e(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var i=0;i<e.length;i++){var s=e[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(t,s.key,s)}}function s(t,e,s){return e&&i(t.prototype,e),s&&i(t,s),Object.defineProperty(t,"prototype",{writable:!1}),t}function n(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&r(t,e)}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function r(t,e){return r=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},r(t,e)}function a(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function o(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var i,s=h(t);if(e){var n=h(this).constructor;i=Reflect.construct(s,arguments,n)}else i=s.apply(this,arguments);return a(this,i)}}function u(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}function l(){return l="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,i){var s=u(t,e);if(s){var n=Object.getOwnPropertyDescriptor(s,e);return n.get?n.get.call(arguments.length<3?t:i):n.value}},l.apply(this,arguments)}function c(t,e,i,s){return c="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(t,e,i,s){var n,h=u(t,e);if(h){if((n=Object.getOwnPropertyDescriptor(h,e)).set)return n.set.call(s,i),!0;if(!n.writable)return!1}if(n=Object.getOwnPropertyDescriptor(s,e)){if(!n.writable)return!1;n.value=i,Object.defineProperty(s,e,n)}else!function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(s,e,i);return!0},c(t,e,i,s)}function f(t,e,i,s,n){if(!c(t,e,i,s||t)&&n)throw new Error("failed to set property");return i}function d(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null==i)return;var s,n,h=[],r=!0,a=!1;try{for(i=i.call(t);!(r=(s=i.next()).done)&&(h.push(s.value),!e||h.length!==e);r=!0);}catch(t){a=!0,n=t}finally{try{r||null==i.return||i.return()}finally{if(a)throw n}}return h}(t,e)||y(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function p(t){return function(t){if(Array.isArray(t))return m(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||y(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function y(t,e){if(t){if("string"==typeof t)return m(t,e);var i=Object.prototype.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?m(t,e):void 0}}function m(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,s=new Array(e);i<e;i++)s[i]=t[i];return s}for(var v=function(){function t(i){e(this,t),this.output=i,this.context=i.context,this.sampleRate=this.context?this.context.sampleRate:44100,this.bufferLength=this.sampleRate/30,this.createNewBuffer()}return s(t,[{key:"createNewBuffer",value:function(){this.context?(this.buffer=this.context.createBuffer(1,this.bufferLength,this.sampleRate),this.data=this.buffer.getChannelData(0)):(this.buffer=null,this.data=new Uint8Array(this.bufferLength)),this.index=0}},{key:"writeSample",value:function(t){this.data[this.index++]=t,this.index===this.bufferLength&&(this.output.schedule(this.buffer),this.createNewBuffer())}}]),t}(),C=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30],P=function(){function t(){e(this,t),this.enabled=!1,this.lengthCounter=0,this.lengthCounterHalt=!1}return s(t,[{key:"reset",value:function(){this.enabled=!1,this.length=0}},{key:"enabled",get:function(){return this._enabled},set:function(t){t||(this.lengthCounter=0),this._enabled=t}},{key:"length",get:function(){return this.lengthCounter},set:function(t){this.enabled&&(this.lengthCounter=C[(248&t)>>>3])}},{key:"updateLength",value:function(){this.lengthCounter>0&&!this.lengthCounterHalt&&this.lengthCounter--}}]),t}(),k=[[0,0,0,0,0,0,0,1],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[1,1,1,1,1,1,0,0]],R=function(t){n(r,t);var i=o(r);function r(t){var s;return e(this,r),(s=i.call(this)).id=t,s.constantVolume=0,s.envelopeEnabled=!0,s.envelopeReset=!1,s.envelopeCycle=0,s.envelopePeriod=0,s.envelopeVolume=0,s.envelopeLoop=!1,s.dutyCycle=0,s.duty=0,s.sweepEnabled=!1,s.sweepReset=!1,s.sweepCycle=0,s.sweepPeriod=0,s.sweepNegate=!1,s.sweepShift=0,s.timerCycle=0,s.timerPeriod=0,s}return s(r,[{key:"reset",value:function(){l(h(r.prototype),"reset",this).call(this),this.envelopeCycle=0,this.envelopeVolume=0,this.sweepCycle=0,this.timerCycle=0,this.volume=0,this.sweep=0,this.timer=0}},{key:"volume",get:function(){return(this.envelopeEnabled?this.envelopeVolume:this.constantVolume)*this.duty[this.dutyCycle]},set:function(t){this.duty=k[(192&t)>>>6],t>15?(this.lengthCounterHalt=0!=(32&t),this.envelopeEnabled=0==(16&t),this.constantVolume=15&t):(this.lengthCounterHalt=!1,this.envelopeEnabled=!0,this.constantVolume=t),this.envelopePeriod=this.constantVolume,this.envelopeLoop=this.lengthCounterHalt}},{key:"sweep",get:function(){var t=this.timerPeriod>>>this.sweepShift;return this.sweepNegate?1===this.id?~t:-t:t},set:function(t){this.sweepEnabled=0!=(128&t),this.sweepPeriod=(112&t)>>>4,this.sweepNegate=0!=(8&t),this.sweepShift=7&t,this.sweepReset=!0}},{key:"timer",get:function(){return this.timerPeriod},set:function(t){this.timerPeriod=(1792&this.timerPeriod)+t}},{key:"length",get:function(){return l(h(r.prototype),"length",this)},set:function(t){this.dutyCycle=0,this.envelopeReset=!0,this.timerPeriod=255&this.timerPeriod|(7&t)<<8,f(h(r.prototype),"length",t,this,!0)}},{key:"writeRegister",value:function(t,e){switch(t){case 16384:case 16388:this.volume=e;break;case 16385:case 16389:this.sweep=e;break;case 16386:case 16390:this.timer=e;break;case 16387:case 16391:this.length=e}}},{key:"doCycle",value:function(){--this.timerCycle<=0&&(this.timerCycle=this.timerPeriod+1,this.dutyCycle++,this.dutyCycle>=8&&(this.dutyCycle-=8))}},{key:"doQuarter",value:function(){this.envelopeReset?(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume=15,this.envelopeReset=!1):this.envelopeCycle>0?this.envelopeCycle--:(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume>0?this.envelopeVolume--:this.envelopeLoop&&(this.envelopeVolume=15))}},{key:"doHalf",value:function(){if(this.sweepCycle>0)this.sweepCycle--;else{if(this.sweepEnabled&&this.sweepShift){var t=this.timer;t>=8&&t+this.sweep<2048&&(this.timerPeriod+=this.sweep)}this.sweepCycle=this.sweepPeriod}this.sweepReset&&(this.sweepCycle=this.sweepPeriod,this.sweepReset=!1),this.updateLength()}},{key:"output",get:function(){return this.length>0&&this.timer>=8&&this.timer+this.sweep<2048?this.volume:0}}]),r}(P),g=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0],b=function(t){n(r,t);var i=o(r);function r(){var t;return e(this,r),(t=i.call(this)).dutyCycle=0,t.linearCounter=0,t.linearCounterMax=0,t.linearCounterReset=!1,t.timerCycle=0,t.timerPeriod=0,t}return s(r,[{key:"reset",value:function(){l(h(r.prototype),"reset",this).call(this),this.dutyPosition=0,this.linearCounter=0,this.timerCycle=0,this.counter=0,this.timer=0}},{key:"counter",set:function(t){t>=128?(this.lengthCounterHalt=!0,this.linearCounterMax=t-128):(this.lengthCounterHalt=!1,this.linearCounterMax=t),this.linearCounterControl=this.lengthCounterHalt}},{key:"timer",get:function(){return this.timerPeriod},set:function(t){this.timerPeriod=(1792&this.timerPeriod)+t}},{key:"length",get:function(){return l(h(r.prototype),"length",this)},set:function(t){this.linearCounterReset=!0,this.timerPeriod=255&this.timerPeriod|(7&t)<<8,f(h(r.prototype),"length",t,this,!0)}},{key:"writeRegister",value:function(t,e){switch(t){case 16392:this.counter=e;break;case 16394:this.timer=e;break;case 16395:this.length=e}}},{key:"doCycle",value:function(){this.timerCycle-=2,this.timerCycle<=0&&(this.timerCycle=this.timerPeriod+1,this.lengthCounter&&this.linearCounter&&this.timerPeriod>3&&(this.dutyCycle++,this.dutyCycle>=32&&(this.dutyCycle-=32)))}},{key:"doQuarter",value:function(){this.linearCounterReset?this.linearCounter=this.linearCounterMax:this.linearCounter>0&&this.linearCounter--,this.linearCounterControl||(this.linearCounterReset=!1)}},{key:"doHalf",value:function(){this.updateLength()}},{key:"output",get:function(){return g[this.dutyCycle]}}]),r}(P),A=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068],O=function(t){n(r,t);var i=o(r);function r(){var t;return e(this,r),(t=i.call(this)).constantVolume=0,t.envelopeEnabled=!0,t.envelopeReset=!1,t.envelopeCycle=0,t.envelopePeriod=0,t.envelopeVolume=0,t.envelopeLoop=!1,t.timerMode=!1,t.timerCycle=0,t.timerPeriod=0,t.shiftRegister=1,t}return s(r,[{key:"reset",value:function(){l(h(r.prototype),"reset",this).call(this),this.envelopeCycle=0,this.envelopeVolume=0,this.timerCycle=0,this.shiftRegister=1,this.volume=0,this.timer=0}},{key:"volume",get:function(){return this.envelopeEnabled?this.envelopeVolume:this.constantVolume},set:function(t){t>15?(this.lengthCounterHalt=0!=(32&t),this.envelopeEnabled=0==(16&t),this.constantVolume=15&t):(this.lengthCounterHalt=!1,this.envelopeEnabled=!0,this.constantVolume=t),this.envelopeLoop=this.lengthCounterHalt,this.envelopePeriod=this.constantVolume}},{key:"timer",get:function(){return this.timerPeriod},set:function(t){t>15?(this.timerMode=t>=128,this.timerPeriod=A[15&t]):(this.timerMode=!1,this.timerPeriod=A[t])}},{key:"length",get:function(){return l(h(r.prototype),"length",this)},set:function(t){this.envelopeReset=!0,f(h(r.prototype),"length",t,this,!0)}},{key:"writeRegister",value:function(t,e){switch(t){case 16396:this.volume=e;break;case 16398:this.timer=e;break;case 16399:this.length=e}}},{key:"doCycle",value:function(){if(--this.timerCycle<=0){this.timerCycle=this.timerPeriod;var t=1&this.shiftRegister;this.timerMode?t^=this.shiftRegister>>>6&1:t^=this.shiftRegister>>>1&1,this.shiftRegister=this.shiftRegister>>>1|t<<14}}},{key:"doQuarter",value:function(){this.envelopeReset?(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume=15,this.envelopeReset=!1):this.envelopeCycle>0?this.envelopeCycle--:(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume>0?this.envelopeVolume--:this.envelopeLoop&&(this.envelopeVolume=15))}},{key:"doHalf",value:function(){this.updateLength()}},{key:"output",get:function(){return this.length>0&&!(1&this.shiftRegister)?this.volume:0}}]),r}(P),w=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54],B=function(){function t(i){e(this,t),this.cpu=i,this.enabled=!1,this.cycle=0,this.output=0,this.timerCycle=0,this.timerPeriod=0,this.sampleAddress=0,this.sampleLength=0,this.sampleIndex=0,this.sampleLeft=0,this.sampleLoop=!1,this.sampleBuffer=-1,this.shiftRegister=-1,this.shiftRegisterBits=0,this.irqEnabled=!1,this.irq=!1}return s(t,[{key:"reset",value:function(){this.cycle=0,this.timerCycle=0,this.sampleBuffer=-1,this.shiftRegister=-1,this.shiftRegisterBits=0,this.rate=0,this.load=0,this.address=0,this.length=0}},{key:"enabled",get:function(){return this._enabled},set:function(t){t?0===this.sampleLeft&&(this.sampleIndex=0,this.sampleLeft=this.sampleLength):this.sampleLeft=0,this.irq=!1,this._enabled=t}},{key:"doIRQ",value:function(){this.irq=!0,this.irqEnabled&&this.cpu.doIRQ()}},{key:"rate",get:function(){return this.timerPeriod},set:function(t){t>=64?(this.irqEnabled=0!=(128&t),this.sampleLoop=0!=(64&t),this.timerPeriod=w[15&t]):(this.irqEnabled=!1,this.sampleLoop=!1,this.timerPeriod=t>15?w[15&t]:w[t]),this.irqEnabled||(this.irq=!1)}},{key:"load",get:function(){return this.output},set:function(t){t>=128&&(t-=128),this.output=t}},{key:"address",get:function(){return this.sampleAddress},set:function(t){this.sampleAddress=49152+64*t}},{key:"length",get:function(){return this.sampleLength},set:function(t){this.sampleLength=16*t+1}},{key:"writeRegister",value:function(t,e){switch(t){case 16400:this.rate=e;break;case 16401:this.load=e;break;case 16402:this.address=e;break;case 16403:this.length=e}}},{key:"doCycle",value:function(){this.cycle>0&&this.cycle--,--this.timerCycle<=0&&(this.timerCycle=this.timerPeriod,this.updateSampleBuffer(),this.updateShiftRegister(),this.updateOutput())}},{key:"updateSampleBuffer",value:function(){this.sampleBuffer<0&&this.sampleLeft>0&&(this.sampleBuffer=this.cpu.read(this.sampleAddress+this.sampleIndex++),this.cycle=4,--this.sampleLeft<=0&&(this.sampleLoop?(this.sampleIndex=0,this.sampleLeft=this.sampleLength):this.irqEnabled&&this.doIRQ()))}},{key:"updateShiftRegister",value:function(){--this.shiftRegisterBits<=0&&(this.shiftRegisterBits=8,this.shiftRegister=this.sampleBuffer,this.sampleBuffer=-1)}},{key:"updateOutput",value:function(){this.shiftRegister>=0&&(1&this.shiftRegister?this.output<=125&&(this.output+=2):this.output>=2&&(this.output-=2),this.shiftRegister>>>=1)}}]),t}(),N=function(){function t(i){e(this,t),this.bus=i.bus,this.cpu=i,this.pulse1=new R(1),this.pulse2=new R(2),this.triangle=new b,this.noise=new O,this.dmc=new B(i),this.audioBuffer=null,this.cyclesPerSample=0,this.cyclesUntilSample=0,this.irqDisabled=!1,this.irq=!1,this.status=null,this.counter=null,this.carry=0,this.cycle=0}return s(t,[{key:"powerOn",value:function(){this.bus.audioOutput.start(),this.audioBuffer=new v(this.bus.audioOutput),this.cyclesPerSample=894886.3635/this.audioBuffer.sampleRate,this.cyclesUntilSample=this.cyclesPerSample}},{key:"powerOff",value:function(){this.bus.audioOutput.stop(),this.audioBuffer=null}},{key:"reset",value:function(){this.pulse1.reset(),this.pulse2.reset(),this.triangle.reset(),this.noise.reset(),this.dmc.reset(),this.counter=0,this.irq=!1}},{key:"doIRQ",value:function(){this.irq=!0,this.cpu.doIRQ()}},{key:"status",get:function(){var t=(this.pulse1.length&&1)+(this.pulse2.length&&2)+(this.triangle.length&&4)+(this.noise.length&&8)+(this.dmc.sampleLeft&&16)+(this.dmc.irq&&128)+(this.irq&&64);return this.dmc.irq=!1,this.irq=!1,t},set:function(t){null!==t?(this.pulse1.enabled=!!(1&t),this.pulse2.enabled=!!(2&t),this.triangle.enabled=!!(4&t),this.noise.enabled=!!(8&t),this.dmc.enabled=!!(16&t)):(this.pulse1.enabled=!1,this.pulse2.enabled=!1,this.triangle.enabled=!1,this.noise.enabled=!1,this.dmc.enabled=!1)}},{key:"counter",set:function(t){null!==t?(t>=128?(this.counterMode=1,this.irqDisabled=t>=192):(this.counterMode=0,this.irqDisabled=t>=64),this.irqDisabled&&(this.irq=!1),this.resetDelay=this.carry?3:4,1===this.counterMode&&(this.doQuarter(),this.doHalf())):(this.counterMode=0,this.irqDisabled=!1,this.resetDelay=0)}},{key:"readRegister",value:function(t){return 16405===t?this.status:0}},{key:"writeRegister",value:function(t,e){t<=16387?this.pulse1.writeRegister(t,e):t<=16391?this.pulse2.writeRegister(t,e):t<=16395?this.triangle.writeRegister(t,e):t<=16399?this.noise.writeRegister(t,e):t<=16403?this.dmc.writeRegister(t,e):16405===t?this.status=e:16407===t&&(this.counter=e)}},{key:"doCycles",value:function(t){var e=t+this.carry;for(this.carry=e%2,e=(e-this.carry)/2;e--;)this.resetDelay>0&&0==--this.resetDelay&&(this.cycle=0),this.doCycle()}},{key:"doCycle",value:function(){var t=this.cycle++;t<=7457?7457===t&&this.doQuarter():t<=14914?14914===t&&(this.doQuarter(),this.doHalf()):t<=22371?22371===t&&this.doQuarter():t>=29828&&(29828===t&&0===this.counterMode?(this.doQuarter(),this.doHalf(),this.irqDisabled||this.doIRQ(),this.cycle=0):37281===t&&(this.doQuarter(),this.doHalf(),this.cycle=0)),this.pulse1.doCycle(),this.pulse2.doCycle(),this.triangle.doCycle(),this.noise.doCycle(),this.dmc.doCycle(),--this.cyclesUntilSample<=0&&(this.doSample(),this.cyclesUntilSample+=this.cyclesPerSample)}},{key:"doQuarter",value:function(){this.pulse1.doQuarter(),this.pulse2.doQuarter(),this.triangle.doQuarter(),this.noise.doQuarter()}},{key:"doHalf",value:function(){this.pulse1.doHalf(),this.pulse2.doHalf(),this.triangle.doHalf(),this.noise.doHalf()}},{key:"doSample",value:function(){var t=this.pulse1.output+this.pulse2.output,e=3*this.triangle.output+2*this.noise.output+this.dmc.output;this.audioBuffer.writeSample(S[t]+L[e])}}]),t}(),S=new Float32Array(31),M=0;M<31;M++)S[M]=95.52/(8128/M+100);for(var L=new Float32Array(203),E=0;E<203;E++)L[E]=163.67/(24329/E+100);var T=[7,6,2,8,3,3,5,5,3,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,3,2,2,2,3,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,5,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,6,2,6,4,4,4,4,2,5,2,5,5,5,5,5,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,5,2,5,4,4,4,4,2,4,2,4,4,4,4,4,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,3,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7];function I(t){return t>255?t-256:t}var X=function(){function t(i){var s=this;e(this,t),this.bus=i,this.cycle=-1,this.cycleOffset=-1,this.apu=new N(this),this.ram=new Uint8Array(2048),this.stack=this.ram.subarray(256,512),this.nmiVector=function(){return 0},this.resetVector=function(){return 0},this.irqVector=function(){return 0},this.A=255,this.X=255,this.Y=255,this.P=255,this.SP=255,this.PC=65535,this.addressLookup=[this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.abs,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.ind,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroY,this.zeroY,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absY,this.absY,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroY,this.zeroY,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absY,this.absY,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX].map((function(t){return t.bind(s)})),this.instructionLookup=[this.BRK,this.ORA,this.KIL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.PHP,this.ORA,this.ASL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.BPL,this.ORA,this.KIL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.CLC,this.ORA,this.NOP,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.JSR,this.AND,this.KIL,this.NOP,this.BIT,this.AND,this.ROL,this.NOP,this.PLP,this.AND,this.ROL,this.NOP,this.BIT,this.AND,this.ROL,this.NOP,this.BMI,this.AND,this.KIL,this.NOP,this.NOP,this.AND,this.ROL,this.NOP,this.SEC,this.AND,this.NOP,this.NOP,this.NOP,this.AND,this.ROL,this.NOP,this.RTI,this.EOR,this.KIL,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.PHA,this.EOR,this.LSR,this.NOP,this.JMP,this.EOR,this.LSR,this.NOP,this.BVC,this.EOR,this.KIL,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.CLI,this.EOR,this.NOP,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.RTS,this.ADC,this.KIL,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.PLA,this.ADC,this.ROR,this.NOP,this.JMP,this.ADC,this.ROR,this.NOP,this.BVS,this.ADC,this.KIL,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.SEI,this.ADC,this.NOP,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.NOP,this.STA,this.NOP,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.DEY,this.NOP,this.TXA,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.BCC,this.STA,this.KIL,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.TYA,this.STA,this.TXS,this.NOP,this.NOP,this.STA,this.NOP,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.TAY,this.LDA,this.TAX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.BCS,this.LDA,this.KIL,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.CLV,this.LDA,this.TSX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.CPY,this.CMP,this.NOP,this.NOP,this.CPY,this.CMP,this.DEC,this.NOP,this.INY,this.CMP,this.DEX,this.NOP,this.CPY,this.CMP,this.DEC,this.NOP,this.BNE,this.CMP,this.KIL,this.NOP,this.NOP,this.CMP,this.DEC,this.NOP,this.CLD,this.CMP,this.NOP,this.NOP,this.NOP,this.CMP,this.DEC,this.NOP,this.CPX,this.SBC,this.NOP,this.NOP,this.CPX,this.SBC,this.INC,this.NOP,this.INX,this.SBC,this.NOP,this.NOP,this.CPX,this.SBC,this.INC,this.NOP,this.BEQ,this.SBC,this.KIL,this.NOP,this.NOP,this.SBC,this.INC,this.NOP,this.SED,this.SBC,this.NOP,this.NOP,this.NOP,this.SBC,this.INC,this.NOP].map((function(t){return t.bind(s)})),this.isPowered=!1}return s(t,[{key:"powerOn",value:function(){this.cycle=0,this.cycleOffset=0,this.ppu=this.bus.ppu,this.ctrl1=this.bus.ctrlConnector.controllers[0],this.ctrl2=this.bus.ctrlConnector.controllers[1],this.cart=this.bus.cartConnector.cartridge;var t=this.bus.cartConnector.cartridge;this.nmiVector=function(){return t.cpuRead(65530)+256*t.cpuRead(65531)},this.resetVector=function(){return t.cpuRead(65532)+256*t.cpuRead(65533)},this.irqVector=function(){return t.cpuRead(65534)+256*t.cpuRead(65535)},this.A=0,this.X=0,this.Y=0,this.P=52,this.SP=253,this.PC=this.resetVector(),this.apu.powerOn(),this.isPowered=!0}},{key:"powerOff",value:function(){this.apu.powerOff(),this.isPowered=!1}},{key:"reset",value:function(){this.apu.reset(),this.doReset()}},{key:"doInstructions",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;for(t+=this.cycleOffset;this.cycle<=t;){var e=this.doInstruction();this.apu.doCycles(e)}}},{key:"doInstruction",value:function(){var t=this;this.opcode=this.read(this.PC++),this.operand=this.read(this.PC++),this.instructionLookup[this.opcode]((function(e){return t.addressLookup[t.opcode](e)}));var e=T[this.opcode];return this.cycle+=e,e}},{key:"doNMI",value:function(){this.pushWord(this.PC),this.pushByte(-17&this.P),this.PC=this.nmiVector(),this.cycle+=7}},{key:"doReset",value:function(){this.SP=this.SP+3,this.Interrupt=!1,this.PC=this.resetVector(),this.cycle+=7}},{key:"doIRQ",value:function(){this.Interrupt||(this.pushWord(this.PC),this.pushByte(-17&this.P),this.PC=this.irqVector(),this.cycle+=7)}},{key:"read",value:function(t){return t<2048?this.ram[t]:t<8192?this.ram[2047&t]:t<16408?t<16384?this.ppu.readRegister(t):16406===t?t>>>8|this.ctrl1.read():16407===t?t>>>8|this.ctrl2.read():this.apu.readRegister(t):this.cart.cpuRead(t)}},{key:"write",value:function(t,e){if(t<2048)this.ram[t]=e;else if(t<8192)this.ram[2047&t]=e;else if(t<16408)if(t<16384)this.ppu.writeRegister(t,e);else if(16404===t){for(var i=256*e,s=0;s<256;s++)this.ppu.OAMData=this.read(i++);1&this.cycle?this.cycle+=513:this.cycle+=514}else 16406===t?(this.ctrl1.write(e),this.ctrl2.write(e)):this.apu.writeRegister(t,e);else this.cart.cpuWrite(t,e)}},{key:"SP",get:function(){return this._SP},set:function(t){this._SP=I(t)}},{key:"pushByte",value:function(t){this.stack[this.SP--]=t}},{key:"pushWord",value:function(t){this.pushByte(t>>8),this.pushByte(255&t)}},{key:"pullByte",value:function(){return this.SP++,this.stack[this.SP]}},{key:"pullWord",value:function(){return this.pullByte()+256*this.pullByte()}},{key:"Carry",get:function(){return 1&this.P},set:function(t){t?this.P|=1:this.P&=-2}},{key:"Zero",get:function(){return 2&this.P},set:function(t){t?this.P|=2:this.P&=-3}},{key:"Interrupt",get:function(){return 4&this.P},set:function(t){t?this.P|=4:this.P&=-5}},{key:"Decimal",get:function(){return 8&this.P},set:function(t){t?this.P|=8:this.P&=-9}},{key:"Overflow",get:function(){return 64&this.P},set:function(t){t?this.P|=64:this.P&=-65}},{key:"Negative",get:function(){return 128&this.P},set:function(t){t?this.P|=128:this.P&=-129}},{key:"A",get:function(){return this._A},set:function(t){this._A=this.ALU(t)}},{key:"X",get:function(){return this._X},set:function(t){this._X=this.ALU(t)}},{key:"Y",get:function(){return this._Y},set:function(t){this._Y=this.ALU(t)}},{key:"ALU",value:function(t){if(t>255)for(this.Carry=!0;t>255;)t-=256;if(this.Zero=0===t,t<0)for(this.Negative=!0;t<0;)t+=256;else this.Negative=t>=128;return t}},{key:"imp",value:function(t){return this.PC--,t}},{key:"imm",value:function(){return this.PC-1}},{key:"rel",value:function(){return this.cycle++,(t=this.operand)>127?t-256:t;var t}},{key:"zero",value:function(){return this.operand}},{key:"zeroX",value:function(){return I(this.operand+this.X)}},{key:"zeroY",value:function(){return I(this.operand+this.Y)}},{key:"readWord",value:function(){return this.operand+=256*this.read(this.PC++)}},{key:"abs",value:function(){return this.readWord()}},{key:"absX",value:function(){return this.operand+this.X>255&&this.cycle++,this.readWord()+this.X}},{key:"absY",value:function(){return this.operand+this.Y>255&&this.cycle++,this.readWord()+this.Y}},{key:"ind",value:function(){var t=this.readWord();return this.read(t)+256*this.read(t+1)}},{key:"indX",value:function(){var t=I(this.operand+this.X);return this.read(t)+256*this.read(t+1)}},{key:"indY",value:function(){var t=this.read(this.operand)+256*this.read(this.operand+1);return I(t)+this.Y>255&&this.cycle++,t+this.Y}},{key:"BRK",value:function(t){this.pushWord(this.PC),this.pushByte(this.P),this.Interrupt=!0,this.PC=t(this.irqVector())}},{key:"RTI",value:function(t){this.P=this.pullByte(),this.PC=t(this.pullWord())}},{key:"JSR",value:function(t){this.pushWord(this.PC),this.PC=t()}},{key:"RTS",value:function(t){this.PC=t(this.pullWord()+1)}},{key:"JMP",value:function(t){this.PC=t()}},{key:"BPL",value:function(t){this.Negative||(this.PC+=t())}},{key:"BMI",value:function(t){this.Negative&&(this.PC+=t())}},{key:"BVC",value:function(t){this.Overflow||(this.PC+=t())}},{key:"BVS",value:function(t){this.Overflow&&(this.PC+=t())}},{key:"BCC",value:function(t){this.Carry||(this.PC+=t())}},{key:"BCS",value:function(t){this.Carry&&(this.PC+=t())}},{key:"BNE",value:function(t){this.Zero||(this.PC+=t())}},{key:"BEQ",value:function(t){this.Zero&&(this.PC+=t())}},{key:"PHA",value:function(t){this.pushByte(t(this.A))}},{key:"PHP",value:function(t){this.pushByte(t(this.P))}},{key:"PLA",value:function(t){this.A=t(this.pullByte())}},{key:"PLP",value:function(t){this.P=t(this.pullByte())}},{key:"CLC",value:function(t){t(this.Carry=!1)}},{key:"CLD",value:function(t){t(this.Decimal=!1)}},{key:"CLI",value:function(t){t(this.Interrupt=!1)}},{key:"CLV",value:function(t){t(this.Overflow=!1)}},{key:"SEC",value:function(t){t(this.Carry=!0)}},{key:"SED",value:function(t){t(this.Decimal=!0)}},{key:"SEI",value:function(t){t(this.Interrupt=!0)}},{key:"TAX",value:function(t){t(this.X=this.A)}},{key:"TXA",value:function(t){t(this.A=this.X)}},{key:"TAY",value:function(t){t(this.Y=this.A)}},{key:"TYA",value:function(t){t(this.A=this.Y)}},{key:"TSX",value:function(t){t(this.X=this.SP)}},{key:"TXS",value:function(t){t(this.SP=this.X)}},{key:"LDA",value:function(t){this.A=this.read(t())}},{key:"LDX",value:function(t){this.X=this.read(t())}},{key:"LDY",value:function(t){this.Y=this.read(t())}},{key:"STA",value:function(t){this.write(t(),this.A)}},{key:"STX",value:function(t){this.write(t(),this.X)}},{key:"STY",value:function(t){this.write(t(),this.Y)}},{key:"ADC",value:function(t){this.add(this.A,this.read(t()))}},{key:"SBC",value:function(t){this.add(this.A,255-this.read(t()))}},{key:"add",value:function(t,e){var i=t+e+this.Carry;this.Carry=!1,this.Overflow=(t^i)&(e^i)&128,this.A=i}},{key:"ASL",value:function(t){var e;if(10===this.opcode)e=t(this.A),this.A=2*e;else{var i=t();e=this.read(i),this.write(i,this.ALU(2*e))}this.Carry=128&e}},{key:"LSR",value:function(t){var e;if(74===this.opcode)e=t(this.A),this.A=e>>>1;else{var i=t();e=this.read(i),this.write(i,this.ALU(e>>>1))}this.Carry=1&e}},{key:"ROL",value:function(t){var e;if(42===this.opcode)e=t(this.A),this.A=2*e+this.Carry;else{var i=t();e=this.read(i),this.write(i,this.ALU(2*e+this.Carry))}this.Carry=128&e}},{key:"ROR",value:function(t){var e;if(106===this.opcode)e=t(this.A),this.A=(e>>>1)+128*this.Carry;else{var i=t();e=this.read(i),this.write(i,this.ALU((e>>>1)+128*this.Carry))}this.Carry=1&e}},{key:"INC",value:function(t){var e=t();this.write(e,this.ALU(this.read(e)+1))}},{key:"DEC",value:function(t){var e=t();this.write(e,this.ALU(this.read(e)-1))}},{key:"INX",value:function(t){this.X=t(this.X)+1}},{key:"DEX",value:function(t){this.X=t(this.X)-1}},{key:"INY",value:function(t){this.Y=t(this.Y)+1}},{key:"DEY",value:function(t){this.Y=t(this.Y)-1}},{key:"BIT",value:function(t){var e=this.read(t());this.Negative=e>=128,this.Negative?this.Overflow=e>=192:this.Overflow=e>=64,this.Zero=!(this.A&e)}},{key:"CMP",value:function(t){this.compare(this.A,this.read(t()))}},{key:"CPX",value:function(t){this.compare(this.X,this.read(t()))}},{key:"CPY",value:function(t){this.compare(this.Y,this.read(t()))}},{key:"compare",value:function(t,e){this.ALU(t+(256-e)),this.Carry=t>=e}},{key:"ORA",value:function(t){this.A=this.A|this.read(t())}},{key:"AND",value:function(t){this.A=this.A&this.read(t())}},{key:"EOR",value:function(t){this.A=this.A^this.read(t())}},{key:"NOP",value:function(t){t()}},{key:"KIL",value:function(t){this.doReset()}}]),t}(),D=new Uint32Array([4283716692,4285799936,4287631368,4287103024,4284743748,4281335900,4278191188,4278196284,4278200864,4278204936,4278206464,4278205440,4282135040,4278190080,4278190080,4278190080,4288190104,4291054600,4293669424,4293140060,4289729672,4284748960,4280296088,4278205560,4278213204,4278219304,4278221832,4280841728,4286080512,4278190080,4278190080,4278190080,4293717740,4293696076,4293688440,4293681840,4293678308,4290009324,4284771052,4280322260,4278233760,4278240372,4280340556,4285320248,4291605560,4282137660,4278190080,4278190080,4293717740,4293708968,4293704892,4293702356,4293701356,4292128492,4289770732,4287677668,4286108364,4286111412,4287685288,4290044568,4293187232,4288717472,4278190080,4278190080]),x=function(){function t(i,s){e(this,t),this.width=i,this.height=s,this.createNewBuffer()}return s(t,[{key:"createNewBuffer",value:function(){"function"==typeof ImageData?(this.image=new ImageData(this.width,this.height),this.data=new Uint32Array(this.image.data.buffer)):(this.image=null,this.data=new Uint32Array(this.width*this.height))}},{key:"writePixels",value:function(t,e,i){this.data.set(i,e*this.width+t)}},{key:"getFrame",value:function(){var t=this.image;return this.createNewBuffer(),t}}]),t}(),Y=function(){function t(){e(this,t),this.canvas=null,this.context=null,this.layers=[]}return s(t,[{key:"connected",get:function(){return!!this.canvas}},{key:"disconnected",get:function(){return!this.canvas}},{key:"connect",value:function(t){return t&&"CANVAS"===t.nodeName?(this.canvas=t,this.width=t.width,this.height=t.height,t):this.disconnect()}},{key:"disconnect",value:function(){return this.canvas=null}},{key:"addLayer",value:function(t){this.layers.push(t)}},{key:"start",value:function(){this.canvas&&(this.context=this.canvas.getContext("2d",{alpha:!1}),this.context.imageSmoothingEnabled=!1,this.offCanvas=document.createElement("canvas"),this.offCanvas.width=256,this.offCanvas.height=240,this.offContext=this.offCanvas.getContext("2d",{alpha:!0}),this.offContext.imageSmoothingEnabled=!1)}},{key:"stop",value:function(){this.canvas&&(window.cancelAnimationFrame(this.scheduled),this.layers=[],this.context=null,this.offCanvas.remove(),this.offContext=null)}},{key:"schedule",value:function(t){var e=this,i=this.layers.map((function(t){return t.getFrame()}));this.scheduled=window.requestAnimationFrame((function(){e.context.fillStyle=t,e.context.fillRect(0,0,e.width,e.height),i.forEach((function(t){e.offContext.putImageData(t,0,0),e.context.drawImage(e.offCanvas,0,0,256,240,0,0,e.width,e.height)}))}))}}]),t}(),H=D,U=["#545454","#001E74","#081090","#300088","#440064","#5C0030","#540400","#3C1800","#202A00","#083A00","#004000","#003C00","#00323C","#000000","#000000","#000000","#989698","#084CC4","#3032EC","#5C1EE4","#8814B0","#A01464","#982220","#783C00","#545A00","#287200","#087C00","#007628","#006678","#000000","#000000","#000000","#ECEEEC","#4C9AEC","#787CEC","#B062EC","#E454EC","#EC58B4","#EC6A64","#D48820","#A0AA00","#74C400","#4CD020","#38CC6C","#38B4CC","#3C3C3C","#000000","#000000","#ECEEEC","#A8CCEC","#BCBCEC","#D4B2EC","#ECAEEC","#ECAED4","#ECB4B0","#E4C490","#CCD278","#B4DE78","#A8E290","#98E2B4","#A0D6E4","#A0A2A0","#000000","#000000"],V={0:0,32768:1,128:2,32896:3},z=function(){function t(i){e(this,t),this.bus=i,this.vblank=!1,this.vram=new Uint8Array(2048),this.vramBank=[this.vram.subarray(0,1024),this.vram.subarray(1024,2048)],this.oamPrimary=new Uint8Array(256),this.oamSecondary=new Uint8Array(32),this.oamAddress=0,this.oamIndex=0,this.palette=[new Uint8Array(16),new Uint8Array(16)],this.bkgPixelsBuffer=new Uint32Array(16),this.sprPixelsBuffer=new Uint32Array(8),this.bkgLayer=new x(264,256),this.sprBehindLayer=new x(264,256),this.sprInFrontLayer=new x(264,256),this.sprLayer=this.sprInFrontLayer,this.sprite0Layer=new Uint32Array(264),this.isPowered=!1}return s(t,[{key:"powerOn",value:function(){this.control=null,this.mask=null,this.status=null,this.OAMAddress=null,this.oamPrimary.fill(0),this.scroll=null,this.address=null,this.data=null,this.ntsc="NTSC"===this.bus.cartConnector.tvSystem,this.cpu=this.bus.cpu,this.cart=this.bus.cartConnector.cartridge,this.output=this.bus.videoOutput,this.output.addLayer(this.sprBehindLayer),this.output.addLayer(this.bkgLayer),this.output.addLayer(this.sprInFrontLayer),this.output.start(),this.isPowered=!0}},{key:"powerOff",value:function(){this.output.stop(),this.isPowered=!1}},{key:"reset",value:function(){this.control=null,this.mask=null,this.scroll=null,this.data=null}},{key:"doVBlank",value:function(){this.vblank=!0,this.nmiEnabled&&this.cpu.doNMI()}},{key:"endVBlank",value:function(){this.status=null}},{key:"control",set:function(t){null!==t?(this.addressBuffer&=-3073,this.addressBuffer|=(3&t)<<10,this.addressIncrement=4&t?32:1,this.sprPatternTable=8&t?4096:0,this.bkgPatternTable=16&t?4096:0,this.sprite8x16=!!(32&t),this.nmiEnabled=!!(128&t)):(this.addressIncrement=1,this.sprPatternTable=0,this.bkgPatternTable=0,this.sprite8x16=!1,this.nmiEnabled=!1),this.spriteHeight=this.sprite8x16?16:8}},{key:"mask",set:function(t){t?(this.grayscale=!!(1&t),this.showLeftMostBkg=!!(2&t),this.showLeftMostSpr=!!(4&t),this.showBackground=!!(8&t),this.showSprites=!!(16&t),this.emphasizeRed=!!(t&(this.ntsc?32:64)),this.emphasizeGreen=!!(t&(this.ntsc?64:32)),this.emphasizeBlue=!!(128&t),this.renderingEnabled=!!(24&t)):(this.grayscale=!1,this.showLeftMostBkg=!1,this.showLeftMostSpr=!1,this.showBackground=!1,this.showSprites=!1,this.emphasizeRed=!1,this.emphasizeGreen=!1,this.emphasizeBlue=!1,this.renderingEnabled=!1)}},{key:"status",get:function(){var t=(this.spriteOverflow&&32)|(this.sprite0Hit&&64)|(this.vblank&&128);return this.vblank=!1,this.writeToggle=!1,t},set:function(t){this.spriteOverflow=!1,this.sprite0Hit=!1,this.sprite0=!1,this.vblank=!1}},{key:"OAMAddress",set:function(t){this.oamAddress=t||0}},{key:"OAMData",get:function(){return this.oamPrimary[this.oamAddress]},set:function(t){this.oamPrimary[this.oamAddress++]=t,this.oamAddress>255&&(this.oamAddress=0)}},{key:"scroll",set:function(t){if(null!==t){var e=this.writeToggle,i=this.addressBuffer;e?(i&=3103,i|=(7&t)<<12,i|=(248&t)<<2,this.fineScrollY=7&t):(i&=32736,i|=t>>>3,this.fineScrollX=7&t),this.addressBuffer=i,this.writeToggle=!e}else this.writeToggle=!1,this.fineScrollX=0,this.fineScrollY=0}},{key:"address",set:function(t){if(null!==t){var e=this.writeToggle;e?(this.addressBuffer=65280&this.addressBuffer|t,this.addressBus=this.addressBuffer):(t=(63&t)<<8,this.addressBuffer=255&this.addressBuffer|t),this.writeToggle=!e}else this.writeToggle=!1,this.addressBus=this.addressBuffer=0}},{key:"data",get:function(){var t,e=this.addressBus;return t=e>=16128?this.readPalette(e):this.readBuffer,this.readBuffer=this.read(e),this.addressBus=e+this.addressIncrement,t},set:function(t){if(null!==t){var e=this.addressBus;e>=16128?this.writePalette(e,t):this.write(e,t),this.addressBus=e+this.addressIncrement}else this.readBuffer=0}},{key:"readRegister",value:function(t){switch(t>8199&&(t&=8199),t){case 8194:return this.status;case 8196:return this.OAMData;case 8199:return this.data;default:return 0}}},{key:"writeRegister",value:function(t,e){switch(t>8199&&(t&=8199),t){case 8192:this.control=e;break;case 8193:this.mask=e;break;case 8195:this.OAMAddress=e;break;case 8196:this.OAMData=e;break;case 8197:this.scroll=e;break;case 8198:this.address=e;break;case 8199:this.data=e}}},{key:"read",value:function(t){var e=this.cart;return e.ciramEnabled(t)?this.vramBank[e.ciramA10(t)?1:0][1023&t]:e.ppuRead(t)}},{key:"write",value:function(t,e){var i=this.cart;i.ciramEnabled(t)?this.vramBank[i.ciramA10(t)?1:0][1023&t]=e:i.ppuWrite(t,e)}},{key:"backdrop",get:function(){return this.palette[0][0]}},{key:"bkgPalette",get:function(){return this.palette[0]}},{key:"sprPalette",get:function(){return this.palette[1]}},{key:"readPalette",value:function(t){return 3&t?this.palette[(16&t)>>>4][15&t]:this.palette[0][0]}},{key:"writePalette",value:function(t,e){3&t?this.palette[(16&t)>>>4][15&t]=e:this.palette[0][15&t]=e}},{key:"incrementX",value:function(){if(this.renderingEnabled){var t=this.addressBus;31==(31&t)?(t&=32736,t^=1024):t++,this.addressBus=t}}},{key:"incrementY",value:function(){if(this.renderingEnabled){var t=this.addressBus;if(t<28672)t+=4096,this.fineScrollY++;else{var e=992&(t-=28672);928===e?(t&=3103,t^=2048):992===e?t&=64543:t+=32,this.fineScrollY=t>>>12}this.addressBus=t}}},{key:"resetX",value:function(){if(this.renderingEnabled){var t=this.addressBus;t&=31712,t|=1055&this.addressBuffer,this.addressBus=t}}},{key:"resetY",value:function(){if(this.renderingEnabled){var t=this.addressBus;t&=1055,t|=31712&this.addressBuffer,this.addressBus=t,this.fineScrollY=t>>>12}}},{key:"fetchNameTable",value:function(t){var e=8192+(4095&t);return this.read(e)}},{key:"fetchAttributeTable",value:function(t){var e=9152|3072&t|t>>>4&56|t>>>2&7,i=0;return 2&t&&(i+=2),64&t&&(i+=4),this.read(e)>>>i&3}},{key:"fetchBkgPatternTable",value:function(t,e){var i=this.bkgPatternTable+16*t+e;return 256*this.read(i)+this.read(i+8)}},{key:"fetchTile",value:function(){if(this.showBackground){var t=this.addressBus,e=this.fetchNameTable(t),i=this.fetchAttributeTable(t),s=this.fetchBkgPatternTable(e,this.fineScrollY);this.bkgPixelsBuffer.copyWithin(0,8),this.setPatternPixels(this.bkgPixelsBuffer.subarray(8),s,this.bkgPalette,i)}}},{key:"fetchNullTile",value:function(){if(this.showBackground){var t=this.addressBus,e=this.fetchNameTable(t);this.fetchAttributeTable(t),this.fetchBkgPatternTable(e,this.fineScrollY)}}},{key:"fetchNullNTs",value:function(){if(this.showBackground){var t=this.addressBus;this.fetchNameTable(t),this.fetchNameTable(t)}}},{key:"renderTile",value:function(t,e){if(this.showBackground){var i=this.fineScrollX,s=this.bkgPixelsBuffer.subarray(i,i+8);this.sprite0&&!this.sprite0Hit&&this.sprite0Layer.subarray(t,t+8).some((function(t,e){return t&&s[e]}))&&(this.sprite0Hit=!0),this.bkgLayer.writePixels(t,e,s)}}},{key:"clearSecondaryOAM",value:function(){this.oamSecondary.fill(255),this.oamIndex=0}},{key:"evaluateSprites",value:function(t){for(var e=this.oamPrimary,i=this.oamSecondary,s=this.spriteHeight;this.oamAddress<256;){var n=e[this.oamAddress],h=n+s,r=n;if(32===this.oamIndex)this.oamAddress++,this.oamIndex++;else{if(this.oamIndex<32&&(i[this.oamIndex]=n),t>=r&&t<h){if(!(this.oamIndex<32)){this.spriteOverflow=!0;break}0===this.oamAddress&&(this.sprite0=!0);for(var a=1;a<4;a++)i[this.oamIndex+a]=e[this.oamAddress+a];this.oamIndex+=4}this.oamAddress+=4}}this.oamIndex=0}},{key:"fetchSprPatternTable",value:function(t,e){var i=this.sprPatternTable;this.sprite8x16&&(i=(1&t)<<12,t&=254);var s=i+16*t+e;return 256*this.read(s)+this.read(s+8)}},{key:"fetchSprite",value:function(t){if(this.showSprites){var e=this.addressBus;this.fetchNameTable(e),this.fetchAttributeTable(e),this.oamAddress=0;var i=this.oamSecondary;this.sprite0&&(this.sprite0=0===this.oamIndex);var s,n=t-i[this.oamIndex++],h=i[this.oamIndex++],r=i[this.oamIndex++];r>=128&&(n=this.spriteHeight-n-1,r-=128),r>=64&&(s=!0,r-=64),r>=32?(this.sprLayer=this.sprBehindLayer,r-=32):this.sprLayer=this.sprInFrontLayer,n>=8&&(n-=8,h++);var a=this.fetchSprPatternTable(h,n);this.setPatternPixels(this.sprPixelsBuffer,a,this.sprPalette,r,s)}}},{key:"fetchNullSprite",value:function(){if(this.showSprites){var t=this.addressBus;this.fetchNameTable(t),this.fetchAttributeTable(t),this.fetchSprPatternTable(this.sprPatternTable,255)}}},{key:"renderSprite",value:function(t){if(this.showSprites){var e=this.oamSecondary[this.oamIndex++],i=this.sprPixelsBuffer;this.sprite0&&this.sprite0Layer.fill(0).set(i,e),this.sprLayer.writePixels(e,t+1,i)}}},{key:"setPatternPixels",value:function(t,e,i,s,n){s>=4&&(s%=4);for(var h=4*s,r=0;r<8;r++){var a=V[e<<r&32896];t[n?7-r:r]=a?H[i[h+a]]:0}}},{key:"printFrame",value:function(){this.output.schedule(U[this.backdrop])}}]),t}(),F=1e3/60,G=341/3,K=29780.5,_=27393.666666666668,W=29659,j=function(){function t(i){e(this,t),this.bus=i,this.firstLoop=this.firstLoop.bind(this),this.mainLoop=this.mainLoop.bind(this),this.runningLoop=null,this.init(),this.isPowered=!1,this.isPaused=!1}return s(t,[{key:"init",value:function(){this.frame=0,this.dropped=0,this.fps=60,this.performance=1,this._delta=0,this._lastTimestamp=0,this._frameTimeThisSecond=0,this._framesThisSecond=0,this._fps=60}},{key:"powerOn",value:function(){this.cpu=this.bus.cpu,this.ppu=this.bus.ppu,this.init(),this.coldBoot(),this.isPowered=!0,this.isPaused=!1}},{key:"powerOff",value:function(){clearTimeout(this.runningLoop),this.runningLoop=null,this.isPowered=!1,this.isPaused=!1}},{key:"pause",value:function(){return this.isPaused?(this.runningLoop=setTimeout(this.firstLoop,0),this.isPaused=!1):(clearTimeout(this.runningLoop),this.runningLoop=null,this.isPaused=this.isPowered),this.isPaused}},{key:"coldBoot",value:function(){var t=this.cpu,e=this.ppu;t.cycleOffset=0,t.doInstructions(2279),e.vblank=!0,t.doInstructions(4757),e.vblank=!0,t.doInstructions(_),e.doVBlank(),t.doInstructions(W),e.endVBlank(),this.doPreFetch(t,e,261),this.runningLoop=setTimeout(this.firstLoop,0)}},{key:"firstLoop",value:function(){if("undefined"!=typeof window){var t=window.performance.now(),e=this.cpu,i=this.ppu;this.doFrame(e,i),this.updateStats(window.performance.now()-t),this._lastTimestamp=t,this.runningLoop=setTimeout(this.mainLoop,0)}}},{key:"mainLoop",value:function(){var t=window.performance.now();if(this._delta=t-this._lastTimestamp,this._delta>=F){if(this._delta>1e3)return void this.pause();for(var e=this.cpu,i=this.ppu;(this._delta-=F)>=F;)this.skipFrame(e,i),this._fps--;this.doFrame(e,i),this.updateStats(window.performance.now()-t),this._lastTimestamp=t}this.runningLoop=setTimeout(this.mainLoop,0)}},{key:"updateStats",value:function(t){this._frameTimeThisSecond+=t,this._framesThisSecond++,this._framesThisSecond>=this._fps&&(this.performance=1e3/this._frameTimeThisSecond,this.fps=this._fps,this._frameTimeThisSecond=0,this._framesThisSecond=0,this._fps=60)}},{key:"doFrame",value:function(t,e){t.cycleOffset=this.frame*K;for(var i=0;i<=239;i++)this.doScanline(t,e,i);t.doInstructions(_),e.printFrame(),e.doVBlank(),t.doInstructions(W),e.endVBlank(),this.doPreRenderLine(t,e),this.frame++}},{key:"skipFrame",value:function(t,e){t.cycleOffset=this.frame*K,t.doInstructions(_),e.doVBlank(),t.doInstructions(W),e.endVBlank(),t.doInstructions(K),this.frame++,this.dropped++}},{key:"doScanline",value:function(t,e,i){var s=i*G,n=0;for(e.clearSecondaryOAM();n<64;)t.doInstructions(s+n/3),e.renderTile(n,i),e.fetchTile(),e.incrementX(),n+=8;for(e.evaluateSprites(i);n<248;)t.doInstructions(s+n/3),e.renderTile(n,i),e.fetchTile(),e.incrementX(),n+=8;for(t.doInstructions(s+n/3),e.renderTile(n,i),e.fetchNullTile(),e.incrementY(),e.resetX(),n+=8;n<320;)t.doInstructions(s+n/3),e.fetchSprite(i),e.renderSprite(i),n+=8;this.doPreFetch(t,e,i)}},{key:"doPreRenderLine",value:function(t,e){for(var i=29667,s=0;s<256;)t.doInstructions(i+s/3),e.fetchNullTile(),e.incrementX(),s+=8;for(e.incrementY(),e.resetX();s<279;)t.doInstructions(i+s/3),e.fetchNullSprite(),s+=8;for(;s<304;)t.doInstructions(i+s/3),e.fetchNullSprite(),e.resetY(),s+=8;for(;s<320;)t.doInstructions(i+s/3),e.fetchNullSprite(),s+=8;this.doPreFetch(t,e,261)}},{key:"doPreFetch",value:function(t,e,i){for(var s=i*G,n=320;n<336;)t.doInstructions(s+n/3),e.fetchTile(),e.incrementX(),n+=8;e.fetchNullNTs()}}]),t}(),q=function(){function t(i){e(this,t),this.mapperNumber=void 0!==i?i:-1,this.PRGRAM=new Uint8Array(16384),this.CHRRAM=new Uint8Array(8192),this.PRGROM=[],this.CHRROM=[],this.PRGBank=[this.PRGRAM,this.PRGRAM],this.CHRBank=[this.CHRRAM,this.CHRRAM],this.horiMirroring=!1,this.vertMirroring=!1,this.battery=!1}return s(t,[{key:"empty",get:function(){return this.mapperNumber<0}},{key:"present",get:function(){return this.mapperNumber>=0}},{key:"init",value:function(){this.PRGROM.length>0?this.PRGBank=[this.PRGROM[0],this.PRGROM[this.PRGROM.length-1]]:this.PRGBank=[this.PRGRAM,this.PRGRAM],0===this.CHRROM.length&&(this.CHRROM=[this.CHRRAM.subarray(0,4096),this.CHRRAM.subarray(4096)]),this.CHRBank=[this.CHRROM[0],this.CHRROM[1]]}},{key:"cpuRead",value:function(t){if(t>=49152)return this.PRGBank[1][t-49152];if(t>=32768)return this.PRGBank[0][t-32768];for(t>=24576&&(t-=24576);t>8191;)t-=8192;return this.PRGRAM[t]}},{key:"cpuWrite",value:function(t,e){for(t>=24576&&(t-=24576);t>8191;)t-=8192;this.PRGRAM[t]=e}},{key:"ppuRead",value:function(t){if(t<4096)return this.CHRBank[0][t];if(t<8192)return this.CHRBank[1][t-4096];for(t-=8192;t>4095;)t-=4096;return this.CHRBank[1][t]}},{key:"ppuWrite",value:function(t,e){for(;t>8191;)t-=8192;this.CHRRAM[t]=e}},{key:"ciramA10",value:function(t){return 0}},{key:"ciramEnabled",value:function(t){return t<8192?0:t<16384?8192:8192&t}}]),t}(),Q=function(t){n(h,t);var i=o(h);function h(t){return e(this,h),i.call(this,t||0)}return s(h,[{key:"ciramA10",value:function(t){return t<1024?0:this.vertMirroring?1024&t:t<2048?0:this.horiMirroring?2048&t:0}}]),h}(q),J=function(t){n(r,t);var i=o(r);function r(t){var s;return e(this,r),(s=i.call(this,t||1)).mirroring=0,s.PRGBankMode=3,s.CHRBankMode=0,s.buffer=0,s.index=0,s}return s(r,[{key:"init",value:function(){l(h(r.prototype),"init",this).call(this),this.firstPRGBank=this.PRGROM[0],this.lastPRGBank=this.PRGROM[this.PRGROM.length-1],this.PRGBank[0]=this.firstPRGBank,this.PRGBank[1]=this.lastPRGBank}},{key:"control",set:function(t){this.mirroring=3&t,this.PRGBankMode=(12&t)>>2,this.CHRBankMode=(16&t)>>4}},{key:"CHR0",set:function(t){if(1===this.CHRBankMode)this.CHRBank[0]=this.CHRROM[t];else{var e=-2&t;this.CHRBank[0]=this.CHRROM[e+0],this.CHRBank[1]=this.CHRROM[e+1]}}},{key:"CHR1",set:function(t){1===this.CHRBankMode&&(this.CHRBank[1]=this.CHRROM[t])}},{key:"PRG",set:function(t){for(;t>=16;)t-=16;if(3===this.PRGBankMode)this.PRGBank[0]=this.PRGROM[t],this.PRGBank[1]=this.lastPRGBank;else if(2===this.PRGBankMode)this.PRGBank[0]=this.firstPRGBank,this.PRGBank[1]=this.PRGROM[t];else{var e=-2&t;this.PRGBank[0]=this.PRGROM[e+0],this.PRGBank[1]=this.PRGROM[e+1]}}},{key:"write",value:function(t,e){switch(t-32768){case 0:this.control=e;break;case 8192:this.CHR0=e;break;case 16384:this.CHR1=e;break;case 24576:this.PRG=e;break;default:this.write(57344&t,e)}}},{key:"cpuWrite",value:function(t,e){t>=32768?e>=128?(this.buffer=0,this.index=0,this.mirroring=0,this.CHRBankMode=0):(this.buffer+=(1&e)<<this.index,5==++this.index&&(this.write(t,this.buffer),this.buffer=0,this.index=0)):l(h(r.prototype),"cpuWrite",this).call(this,t,e)}},{key:"ciramA10",value:function(t){return 3===this.mirroring?t<2048?0:2048&t:2===this.mirroring?t<1024?0:1024&t:this.mirroring}}]),r}(q),Z=Object.freeze(["NROM","Nintendo MMC1","UNROM","CNROM","Nintendo MMC3","Nintendo MMC5","FFE Rev. A","ANROM","","Nintendo MMC2","Nintendo MMC4","Color Dreams","REX DBZ 5","CPROM","REX SL-1632","100-in-1","BANDAI 24C02","FFE Rev. B","JALECO SS880006","Namcot 163","","Konami VRC4a/VRC4c","Konami VRC2a","Konami VRC2b/VRC4e","Konami VRC6a","Konami VRC4b/VRC4d","Konami VRC6b","CC-21 MI HUN CHE","","","","","IREM G-101","TC0190FMC/TC0350FMR","IREM I-IM/BNROM","Wario Land 2","TXC Policeman","PAL-ZZ SMB/TETRIS/NWC","Bit Corp.","","SMB2j FDS","CALTRON 6-in-1","BIO MIRACLE FDS","FDS SMB2j LF36","MMC3 BMC PIRATE A","MMC3 BMC PIRATE B","RUMBLESTATION 15-in-1","NES-QJ SSVB/NWC","TAITO TCxxx","MMC3 BMC PIRATE C","SMB2j FDS Rev. A","11-in-1 BALL SERIES","MMC3 BMC PIRATE D","SUPERVISION 16-in-1","","","","SIMBPLE BMC PIRATE A","SIMBPLE BMC PIRATE B","","SIMBPLE BMC PIRATE C","20-in-1 KAISER Rev. A","700-in-1","","TENGEN RAMBO1","IREM-H3001","MHROM","SUNSOFT-FZII","Sunsoft Mapper #4","SUNSOFT-5/FME-7","BA KAMEN DISCRETE","CAMERICA BF9093","JALECO JF-17","KONAMI VRC3","TW MMC3+VRAM Rev. A","KONAMI VRC1","NAMCOT 108 Rev. A","IREM LROG017","Irem 74HC161/32","AVE/C&E/TXC BOARD","TAITO X1-005 Rev. A","","TAITO X1-017","YOKO VRC Rev. B","","KONAMI VRC7","JALECO JF-13","74*139/74 DISCRETE","NAMCO 3433","SUNSOFT-3","HUMMER/JY BOARD","EARLY HUMMER/JY BOARD","JALECO JF-19","SUNSOFT-3R","HVC-UN1ROM","NAMCOT 108 Rev. B","BANDAI OEKAKIDS","IREM TAM-S1","","VS Uni/Dual- system","","","","FDS DOKIDOKI FULL","","NES-EVENT NWC1990","SMB3 PIRATE A","MAGIC CORP A","FDS UNROM BOARD","","","","ASDER/NTDEC BOARD","HACKER/SACHEN BOARD","MMC3 SG PROT. A","MMC3 PIRATE A","MMC1/MMC3/VRC PIRATE","FUTURE MEDIA BOARD","TSKROM","NES-TQROM","FDS TOBIDASE","MMC3 PIRATE PROT. A","","MMC3 PIRATE H2288","","FDS LH32","","","","","","","TXC/MGENIUS 22111","SA72008","MMC3 BMC PIRATE","","TCU02","S8259D","S8259B","S8259C","JALECO JF-11/14","S8259A","UNLKS7032","TCA01","AGCI 50282","SA72007","SA0161M","TCU01","SA0037","SA0036","S74LS374N","","","BANDAI SRAM","","","","BANDAI BARCODE","","BANDAI 24C01","SA009","","","","","","SUBOR Rev. A","SUBOR Rev. B","","","","","","","","","BMCFK23C","","","","","","","","","","","","","","","","TW MMC3+VRAM Rev. B","NTDEC TC-112","TW MMC3+VRAM Rev. C","TW MMC3+VRAM Rev. D","","","TW MMC3+VRAM Rev. E","","","","","","","","NAMCOT 108 Rev. C","TAITO X1-005 Rev. B","","","","","","","","","","","","UNLA9746","Debug Mapper","UNLN625092","","","","","BMC 22+20-in-1","","","","BMC Contra+22-in-1","","BMC QUATTRO","BMC 22+20-in-1 RST","BMC MAXI","","","","UNL6035052","","","","","S74LS374NA","DECATHLON","","FONG SHEN BANG","","","","","","SAN GUO ZHI PIRATE","DRAGON BALL PIRATE","",""]),$=Object.freeze([Q,J]),tt=function(){function t(i){return e(this,t),new($[i]||Q)(i)}return s(t,null,[{key:"supported",value:function(t){return void 0!==$[t]}},{key:"name",value:function(t){return Z[t]||"Unknown"}}]),t}(),et=function(){function t(){e(this,t),this.reset()}return s(t,[{key:"reset",value:function(){this.cartridge=new q,this.name="No Cartridge",this.tvSystem="NTSC",this.statuses=[],this.fileLoaded=!1,this.fileValid=!1,this.fileSupported=!1}},{key:"parseFilename",value:function(t){var e=/\((U|E|Unk|Unl|1|4|A|J|B|K|C|NL|PD|F|S|FC|SW|FN|G|UK|GR|HK|I|H)+\)/.exec(t);e&&(e[0].search(/U[^Kn]|1|4|J|[^U]K|PD|FC|HK/)>0?this.tvSystem="NTSC":e[0].search(/E|A|B|[^F]C|NL|S|SW|FN|G|UK|GR|I|H/)>0?this.tvSystem="PAL":e[0].search(/F[^C]/)>0&&(this.tvSystem="SECAM")),this.name=t.replace(/\.[A-Za-z0-9_]+$/,"").replace(/\s?\((U|E|Unk|Unl|1|4|A|J|B|K|C|NL|PD|F|S|FC|SW|FN|G|UK|GR|HK|I|H)+\)/g,"").replace(/\s?\[(!|a|p|b|t|f|T[+-]|h|o)+\]/g,"").replace(/_+/g," ").trim(),this.name=this.name&&this.name[0].toUpperCase()+this.name.slice(1)}},{key:"parseData",value:function(t){var e=new DataView(t,0,16),i=16;if(1313166106!==e.getUint32(0))throw this.fileValid=!1,new Error("Invalid format");this.statuses.push("iNES format"),this.fileValid=!0;var s=e.getUint8(6),n=s>>4|240&e.getUint8(7);tt.supported(n)?(this.statuses.push("Mapper #".concat(n,": ").concat(tt.name(n))),this.fileSupported=!0):(this.statuses.push("Unsupported mapper (#".concat(n,": ").concat(tt.name(n),")")),this.fileSupported=!1),this.cartridge=new tt(n),8&s?(this.cartridge.horiMirroring=!1,this.cartridge.vertMirroring=!1,this.statuses.push("4-screens scrolling")):1&s?(this.cartridge.horiMirroring=!1,this.cartridge.vertMirroring=!0,this.statuses.push("Horizontal scrolling")):(this.cartridge.horiMirroring=!0,this.cartridge.vertMirroring=!1,this.statuses.push("Vertical scrolling")),2&s&&(this.cartridge.battery=!0,this.statuses.push("Battery-backed SRAM")),4&s&&(this.cartridge.PRGRAM.set(new Uint8Array(t,i,512),4096),i+=512);var h=e.getUint8(4),r=2*e.getUint8(5),a=0;this.statuses.push("".concat(16*h,"kb of PRG-ROM"));for(var o=0;o<h;o++)i+16384>t.byteLength?a+=4:(this.cartridge.PRGROM.push(new Uint8Array(t,i,16384)),i+=16384);for(this.statuses.push("".concat(4*r,"kb of CHR-ROM")),o=0;o<r;o++)i+4096>t.byteLength?a++:(this.cartridge.CHRROM.push(new Uint8Array(t,i,4096)),i+=4096);a>0&&this.statuses.push("".concat(4*a,"kb of data skipped...")),i<t.byteLength&&(this.name=String.fromCharCode.apply(null,new Uint8Array(t,i)).replace(/\0/g,"")),this.cartridge.init()}},{key:"load",value:function(t){var e=this;return this.reset(),new Promise((function(i,s){if(t)if(e.parseFilename(t.name),t.size){var n=new FileReader;n.onabort=function(){return s(new DOMException)},n.onerror=function(){return s(n.error)},n.onload=function(){return i(n.result)},n.readAsArrayBuffer(t)}else s(new Error("File is empty"));else s(new DOMException)})).then((function(t){return e.fileLoaded=!0,e.parseData(t),e})).catch((function(t){return t instanceof DOMException?e.statuses.push("Loading aborted"):t.message?e.statuses.push(t.message):e.statuses.push("Loading failed"),e.cartridge=new q,e}))}},{key:"unload",value:function(){return this.reset(),Promise.resolve(this)}}]),t}(),it=function(){function t(i){e(this,t),this.type=i||"",this.strobing=!1,this.states=new Array(8).fill(0),this.strobe()}return s(t,[{key:"empty",get:function(){return!this.type}},{key:"present",get:function(){return!!this.type}},{key:"strobe",value:function(){this.data=p(this.states)}},{key:"read",value:function(){this.strobing&&this.strobe();var t=this.data.shift();return void 0!==t?t:1}},{key:"write",value:function(t){this.strobing=!!(1&t),this.strobing&&this.strobe()}}]),t}(),st=Object.freeze({a:0,b:1,select:2,start:3,up:4,down:5,left:6,right:7}),nt=function(t){n(h,t);var i=o(h);function h(){var t;return e(this,h),(t=i.call(this,"Joypad")).buttonHandlers=t.states.map((function(e,i){return function(e){t.states[i]=e?1:0}})),t}return s(h,[{key:"getButtonHandler",value:function(t){var e=st[t.toLowerCase()];if(null!=e)return this.buttonHandlers[e];throw new Error("'".concat(t,"' is not a valid button name"))}}]),h}(it),ht=Object.freeze({8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",27:"Escape",32:"Space",33:"Page-up",34:"Page-down",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",45:"Insert",46:"Delete",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",96:"Numpad-0",97:"Numpad-1",98:"Numpad-2",99:"Numpad-3",100:"Numpad-4",101:"Numpad-5",102:"Numpad-6",103:"Numpad-7",104:"Numpad-8",105:"Numpad-9",106:"Multiply",107:"Add",109:"Subtract",110:"Decimal-point",111:"Divide",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"}),rt=function(t){n(h,t);var i=o(h);function h(t){var s;return e(this,h),(s=i.call(this)).keyMap={},t&&s.assignKeys(t),"undefined"!=typeof window&&(window.addEventListener("keydown",(function(t){return s.pressKey(t,!0)})),window.addEventListener("keyup",(function(t){return s.pressKey(t,!1)}))),s}return s(h,[{key:"map",get:function(){return ht}},{key:"assignKey",value:function(t,e){var i=this,s=this.getButtonHandler(t);Object.entries(this.keyMap).forEach((function(t){var e=d(t,2),n=e[0];e[1]===s&&delete i.keyMap[n]})),this.keyMap[e]=s}},{key:"assignKeys",value:function(t){var e=this;Object.entries(t).forEach((function(t){var i=d(t,2),s=i[0],n=i[1];return e.assignKey(s,n)}))}},{key:"pressKey",value:function(t,e){var i=t.keyCode||t.which,s=this.keyMap[i];s&&(s(e),t.preventDefault())}}]),h}(nt),at=function(){function t(){e(this,t),this.controllers=[new it,new it]}return s(t,[{key:"insert",value:function(t){if(this.controllers.indexOf(t)>-1)return t;if(this.controllers[0].empty)this.controllers[0]=t;else{if(!this.controllers[1].empty)return;this.controllers[1]=t}return t}},{key:"remove",value:function(t){var e=this.controllers.indexOf(t);if(e>-1)return this.controllers[e]=new it,t}}]),t}(),ot=function(){function t(){e(this,t),this.context=null,this.gainNode=null}return s(t,[{key:"connected",get:function(){return!!this.element}},{key:"disconnected",get:function(){return!this.element}},{key:"connect",value:function(t){var e=this;return t&&"INPUT"===t.nodeName?(this.element=t,this.value=Number(t.value),this.max=Number(t.max)||100,this.handleVolumeChange=function(t){e.value=t.target.value,e.gainNode&&(e.gainNode.gain.value=e.value/e.max)},this.element.addEventListener("change",this.handleVolumeChange),t):this.disconnect()}},{key:"disconnect",value:function(){return this.element&&this.element.removeEventListener("change",this.handleVolumeChange),this.element=null,this.handleVolumeChange=void 0,this.value=0,this.max=100,null}},{key:"start",value:function(){"function"==typeof AudioContext&&(this.context=new AudioContext,this.gainNode=this.context.createGain(),this.gainNode.gain.value=this.value/this.max,this.gainNode.connect(this.context.destination)),this.next=0}},{key:"stop",value:function(){this.gainNode=null,this.context&&this.context.close(),this.context=null}},{key:"schedule",value:function(t){if(this.context){var e=this.context.createBufferSource();e.buffer=t,e.connect(this.gainNode);var i=e.buffer.duration;this.next<this.context.currentTime?(this.next=this.context.currentTime+i,e.start()):(this.next+=i,e.start(this.next,0,i))}}}]),t}(),ut=function(){function t(){e(this,t),this.cpu=new X(this),this.apu=this.cpu.apu,this.ppu=new z(this),this.engine=new j(this),this.cartConnector=new et,this.ctrlConnector=new at,this.videoOutput=new Y,this.audioOutput=new ot,this.isPowered=!1}return s(t,[{key:"pressPower",value:function(){return this.isPowered?(this.cpu.powerOff(),this.ppu.powerOff(),this.engine.powerOff(),this.isPowered=!1):(this.cpu.powerOn(),this.ppu.powerOn(),this.engine.powerOn(),this.isPowered=!0),this.isPowered}},{key:"pressReset",value:function(){this.cpu.reset(),this.ppu.reset()}},{key:"pause",value:function(){return this.engine.pause()}},{key:"frontLEDState",get:function(){return this.isPowered?this.engine.isPaused?"paused":"on":"off"}},{key:"insertCartridge",value:function(t){return this.cartConnector.load(t)}},{key:"removeCartridge",value:function(){return this.cartConnector.unload()}},{key:"insertController",value:function(t){return this.ctrlConnector.insert(t)}},{key:"removeController",value:function(t){return this.ctrlConnector.remove(t)}},{key:"connectVideo",value:function(t){return this.videoOutput.connect(t)}},{key:"disconnectVideo",value:function(){return this.videoOutput.disconnect()}},{key:"connectAudio",value:function(t){return this.audioOutput.connect(t)}},{key:"disconnectAudio",value:function(){return this.audioOutput.disconnect()}}]),t}();t.APU=N,t.CPU=X,t.Cartridge=q,t.Controller=it,t.Engine=j,t.Keyboard=rt,t.NES=ut,t.PPU=z,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=nestled.umd.min.js.map
