!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?s(exports):"function"==typeof define&&define.amd?define(["exports"],s):s((t="undefined"!=typeof globalThis?globalThis:t||self).Nestled={})}(this,(function(t){"use strict";class s{constructor(){this.isPowered=!1}powerOn(){return this.isPowered=!0}powerOff(){return this.isPowered=!1}reset(){}}class e extends s{constructor(){super(),this.buttons=new i(this),this.subDevices=null}powerOn(){return this.isPowered=!0,this.getSubDevices().forEach((t=>{t.isPowered||t.powerOn()})),this.isPowered}powerOff(){return this.isPowered=!1,this.getSubDevices().forEach((t=>{t.isPowered&&t.powerOff()})),this.isPowered}reset(){this.getSubDevices().forEach((t=>{t.reset()}))}getSubDevices(){if(!this.subDevices){const t=Object.getOwnPropertyNames(this);this.subDevices=t.filter((t=>"bus"!==t&&"object"==typeof this[t]&&this[t]instanceof s)).map((t=>this[t]))}return this.subDevices}}class i{constructor(t){this.pressPower=()=>t.isPowered?t.powerOff():t.powerOn(),this.pressReset=()=>{t.reset()}}}class h{constructor(t=null){this.loaded=!1,this.format="Unknown",this.valid=!1,this.mapperNumber=-1,this.mapperName="",this.supported=!1,this.PRGROMByteLength=0,this.CHRROMByteLength=0,this.horiMirroring=!1,this.vertMirroring=!1,this.battery=!1,this.trainer=!1,this.consoleType=0,this.PRGRAMByteLength=0,this.CHRRAMByteLength=0,this.PRGNVRAMByteLength=0,this.CHRNVRAMByteLength=0,t&&this.parse(t)}get byteLength(){return 0}parse(t){return this.loaded=!!t.byteLength&&t.byteLength>=this.byteLength}}const r=16384,n=4096;class a{constructor(){this.PRGRAM=new Uint8Array(r),this.CHRRAM=new Uint8Array(n),this.PRGROM=[],this.firstPRGBank=this.PRGRAM,this.lastPRGBank=this.PRGRAM,this.PRGBank=[this.firstPRGBank,this.lastPRGBank],this.CHRROM=[],this.firstCHRBank=this.CHRRAM,this.secondCHRBank=this.CHRRAM,this.CHRBank=[this.firstCHRBank,this.secondCHRBank],this.horiMirroring=!1,this.vertMirroring=!1}load(t,s){let e=t.byteLength;this.horiMirroring=t.horiMirroring,this.vertMirroring=t.vertMirroring,t.trainer&&(this.PRGRAM.set(new Uint8Array(s,e,512),4096),e+=512);const i=t.PRGROMByteLength/r;if(i>0){for(let t=0;t<i;t++)this.PRGROM.push(new Uint8Array(s,e,r)),e+=r;this.firstPRGBank=this.PRGROM[0],this.lastPRGBank=this.PRGROM[this.PRGROM.length-1]}this.PRGBank=[this.firstPRGBank,this.lastPRGBank];const h=t.CHRROMByteLength/n;if(h>0){for(let t=0;t<h;t++)this.CHRROM.push(new Uint8Array(s,e,n)),e+=n;this.firstCHRBank=this.CHRROM[0],this.secondCHRBank=this.CHRROM[1]}this.CHRBank=[this.firstCHRBank,this.secondCHRBank]}cpuRead(t){if(t>=49152)return this.PRGBank[1][t-49152];if(t>=32768)return this.PRGBank[0][t-32768];for(t>=24576&&(t-=24576);t>8191;)t-=8192;return this.PRGRAM[t]}cpuWrite(t,s){for(t>=24576&&(t-=24576);t>8191;)t-=8192;this.PRGRAM[t]=s}ppuRead(t){if(t<4096)return this.CHRBank[0][t];if(t<8192)return this.CHRBank[1][t-4096];for(t-=8192;t>4095;)t-=4096;return this.CHRBank[1][t]}ppuWrite(t,s){for(;t>4095;)t-=4096;this.CHRRAM[t]=s}ciramA10(t){return 0}ciramEnabled(t){return!(t<8192)&&(t<16384||(8192&t)>0)}}var o=Object.freeze(["NROM","Nintendo MMC1","UNROM","CNROM","Nintendo MMC3","Nintendo MMC5","FFE Rev. A","ANROM","","Nintendo MMC2","Nintendo MMC4","Color Dreams","REX DBZ 5","CPROM","REX SL-1632","100-in-1","BANDAI 24C02","FFE Rev. B","JALECO SS880006","Namcot 163","","Konami VRC4a/VRC4c","Konami VRC2a","Konami VRC2b/VRC4e","Konami VRC6a","Konami VRC4b/VRC4d","Konami VRC6b","CC-21 MI HUN CHE","","","","","IREM G-101","TC0190FMC/TC0350FMR","IREM I-IM/BNROM","Wario Land 2","TXC Policeman","PAL-ZZ SMB/TETRIS/NWC","Bit Corp.","","SMB2j FDS","CALTRON 6-in-1","BIO MIRACLE FDS","FDS SMB2j LF36","MMC3 BMC PIRATE A","MMC3 BMC PIRATE B","RUMBLESTATION 15-in-1","NES-QJ SSVB/NWC","TAITO TCxxx","MMC3 BMC PIRATE C","SMB2j FDS Rev. A","11-in-1 BALL SERIES","MMC3 BMC PIRATE D","SUPERVISION 16-in-1","","","","SIMBPLE BMC PIRATE A","SIMBPLE BMC PIRATE B","","SIMBPLE BMC PIRATE C","20-in-1 KAISER Rev. A","700-in-1","","TENGEN RAMBO1","IREM-H3001","MHROM","SUNSOFT-FZII","Sunsoft Mapper #4","SUNSOFT-5/FME-7","BA KAMEN DISCRETE","CAMERICA BF9093","JALECO JF-17","KONAMI VRC3","TW MMC3+VRAM Rev. A","KONAMI VRC1","NAMCOT 108 Rev. A","IREM LROG017","Irem 74HC161/32","AVE/C&E/TXC BOARD","TAITO X1-005 Rev. A","","TAITO X1-017","YOKO VRC Rev. B","","KONAMI VRC7","JALECO JF-13","74*139/74 DISCRETE","NAMCO 3433","SUNSOFT-3","HUMMER/JY BOARD","EARLY HUMMER/JY BOARD","JALECO JF-19","SUNSOFT-3R","HVC-UN1ROM","NAMCOT 108 Rev. B","BANDAI OEKAKIDS","IREM TAM-S1","","VS Uni/Dual- system","","","","FDS DOKIDOKI FULL","","NES-EVENT NWC1990","SMB3 PIRATE A","MAGIC CORP A","FDS UNROM BOARD","","","","ASDER/NTDEC BOARD","HACKER/SACHEN BOARD","MMC3 SG PROT. A","MMC3 PIRATE A","MMC1/MMC3/VRC PIRATE","FUTURE MEDIA BOARD","TSKROM","NES-TQROM","FDS TOBIDASE","MMC3 PIRATE PROT. A","","MMC3 PIRATE H2288","","FDS LH32","","","","","","","TXC/MGENIUS 22111","SA72008","MMC3 BMC PIRATE","","TCU02","S8259D","S8259B","S8259C","JALECO JF-11/14","S8259A","UNLKS7032","TCA01","AGCI 50282","SA72007","SA0161M","TCU01","SA0037","SA0036","S74LS374N","","","BANDAI SRAM","","","","BANDAI BARCODE","","BANDAI 24C01","SA009","","","","","","SUBOR Rev. A","SUBOR Rev. B","","","","","","","","","BMCFK23C","","","","","","","","","","","","","","","","TW MMC3+VRAM Rev. B","NTDEC TC-112","TW MMC3+VRAM Rev. C","TW MMC3+VRAM Rev. D","","","TW MMC3+VRAM Rev. E","","","","","","","","NAMCOT 108 Rev. C","TAITO X1-005 Rev. B","","","","","","","","","","","","UNLA9746","Debug Mapper","UNLN625092","","","","","BMC 22+20-in-1","","","","BMC Contra+22-in-1","","BMC QUATTRO","BMC 22+20-in-1 RST","BMC MAXI","","","","UNL6035052","","","","","S74LS374NA","DECATHLON","","FONG SHEN BANG","","","","","","SAN GUO ZHI PIRATE","DRAGON BALL PIRATE","",""]);const l=Object.freeze([class extends a{ciramA10(t){return t<1024?0:this.vertMirroring?1024&t?1:0:t<2048?0:this.horiMirroring&&2048&t?1:0}},class extends a{constructor(){super(),this.mirroring=0,this.PRGBankMode=3,this.CHRBankMode=0,this.buffer=0,this.index=0}set control(t){this.mirroring=3&t,this.PRGBankMode=(12&t)>>2,this.CHRBankMode=(16&t)>>4}set CHR0(t){if(1===this.CHRBankMode)this.CHRBank[0]=this.CHRROM[t];else{const s=-2&t;this.CHRBank[0]=this.CHRROM[s+0],this.CHRBank[1]=this.CHRROM[s+1]}}set CHR1(t){1===this.CHRBankMode&&(this.CHRBank[1]=this.CHRROM[t])}set PRG(t){if(3===this.PRGBankMode){for(;t>=16;)t-=16;this.PRGBank[0]=this.PRGROM[t],this.PRGBank[1]=this.lastPRGBank}else if(2===this.PRGBankMode){for(;t>=16;)t-=16;this.PRGBank[0]=this.firstPRGBank,this.PRGBank[1]=this.PRGROM[t]}else{const s=14&t;this.PRGBank[0]=this.PRGROM[s+0],this.PRGBank[1]=this.PRGROM[s+1]}}write(t,s){switch(t-32768){case 0:this.control=s;break;case 8192:this.CHR0=s;break;case 16384:this.CHR1=s;break;case 24576:this.PRG=s;break;default:this.write(57344&t,s)}}cpuWrite(t,s){t>=32768?s>=128?(this.buffer=0,this.index=0,this.mirroring=0,this.CHRBankMode=0):(this.buffer+=(1&s)<<this.index,5==++this.index&&(this.write(t,this.buffer),this.buffer=0,this.index=0)):super.cpuWrite(t,s)}ciramA10(t){return 3===this.mirroring?t<2048?0:2048&t?1:0:2===this.mirroring?t<1024?0:1024&t?1:0:this.mirroring?1:0}}]),d={create:t=>new(l[t]||a),supported:t=>void 0!==l[t],name:t=>o[t]||"Unknown"},u=16384,c=8192;class p extends h{get byteLength(){return 16}parse(t){if(super.parse(t)){const s=new DataView(t,0,16);if(1313166106===s.getUint32(0)){this.valid=!0,this.format="Archaic iNES";const e=s.getUint8(4),i=s.getUint8(5);this.PRGROMByteLength=f(u,e),this.CHRROMByteLength=f(c,i);const h=s.getUint8(6);this.mapperNumber=h>>4,8&h?(this.horiMirroring=!1,this.vertMirroring=!1):1&h?(this.horiMirroring=!1,this.vertMirroring=!0):(this.horiMirroring=!0,this.vertMirroring=!1),this.battery=!!(2&h),this.trainer=!!(4&h);const r=s.getUint8(7);if(!(4&r))if(this.mapperNumber+=240&r,this.consoleType=3&r,8&r){const h=s.getUint8(9);f(u,e,15&h)+f(c,i,h>>4)<=t.byteLength&&(this.format="NES 2.0",this.parseV2(s))}else 0===s.getUint32(12)&&(this.format="iNES",this.parseV1(s));this.mapperName=d.name(this.mapperNumber),this.supported=d.supported(this.mapperNumber)}}return this.loaded}parseV1(t){this.PRGRAMByteLength=8192*(t.getUint8(8)||1)}parseV2(t){this.mapperNumber+=256*(15&t.getUint8(8));const s=t.getUint8(9);this.PRGROMByteLength=f(u,t.getUint8(4),15&s),this.CHRROMByteLength=f(c,t.getUint8(5),s>>4);const e=t.getUint8(10);this.PRGRAMByteLength=m(15&e),this.PRGNVRAMByteLength=m(e>>4);const i=t.getUint8(11);this.CHRRAMByteLength=m(15&i),this.CHRNVRAMByteLength=m(i>>4)}}function f(t,s,e=0){if(e<15)return(s+256*e)*t;return 2^(s>>2)*(2*(3&s)+1)}function m(t){return t?64<<t:0}class C extends h{get byteLength(){return 32}parse(t){if(super.parse(t)){const s=new DataView(t,0,32);1431193926===s.getUint32(0)&&(this.format="UNIF v"+s.getUint32(4,!0))}return this.loaded}}const R=Object.freeze(["NES/Famicom","Nintendo Vs. System","Nintendo Playchoice 10","Extended Console Type"]),g=Object.freeze({NTSC:"NTSC",PAL:"PAL",SECAM:"SECAM"});class P{constructor(){this.name="No Cartridge",this.format="",this.consoleType=R[0],this.tvSystem=g.NTSC,this.mapper="",this.PRGROM="",this.CHRROM="",this.scrolling="",this.SRAM="",this.PRGRAM="",this.CHRRAM="",this.misc="",this.warnings=[],this.errors=[]}get supported(){return 0===this.warnings.length}get valid(){return 0===this.errors.length}warn(t){this.warnings.push(t)}error(t){this.errors.push(t)}parseFilename(t){const s=/\((U|E|Unk|Unl|1|4|A|J|B|K|C|NL|PD|F|S|FC|SW|FN|G|UK|GR|HK|I|H)+\)/.exec(t);s&&(s[0].search(/U[^Kn]|1|4|J|[^U]K|PD|FC|HK/)>0?this.tvSystem=g.NTSC:s[0].search(/E|A|B|[^F]C|NL|S|SW|FN|G|UK|GR|I|H/)>0?this.tvSystem=g.PAL:s[0].search(/F[^C]/)>0&&(this.tvSystem=g.SECAM),this.tvSystem!==g.NTSC&&this.warn(`Unsupported TV system (${this.tvSystem})`)),this.name=t.replace(/\.[A-Za-z0-9_]+$/,"").replace(/\s?\((U|E|Unk|Unl|1|4|A|J|B|K|C|NL|PD|F|S|FC|SW|FN|G|UK|GR|HK|I|H)+\)/g,"").replace(/\s?\[(!|a|p|b|t|f|T[+-]|h|o)+\]/g,"").replace(/_+/g," ").trim(),this.name&&(this.name=this.name[0].toUpperCase()+this.name.slice(1))}load(t){this.format=t.format,this.mapper=`Mapper #${t.mapperNumber}: ${t.mapperName}`,t.supported||this.warn(`Unsupported mapper (#${t.mapperNumber}:${t.mapperName})`),this.PRGROM=t.PRGROMByteLength/1024+"kb of PRG-ROM",this.CHRROM=t.CHRROMByteLength/1024+"kb of CHR-ROM",t.horiMirroring&&t.vertMirroring?this.scrolling="Scrolling disabled (or Mapper controlled)":t.vertMirroring?this.scrolling="Horizontal scrolling":t.horiMirroring?this.scrolling="Vertical scrolling (or Mapper controlled)":this.scrolling="4-screens scrolling",t.battery&&(this.SRAM="Battery-backed SRAM"),t.trainer&&(this.misc="512b trainer data present"),t.PRGRAMByteLength&&t.PRGNVRAMByteLength?this.PRGRAM=(t.PRGRAMByteLength+t.PRGNVRAMByteLength)/1024+"kb of combined PRG-RAM/NVRAM":t.PRGNVRAMByteLength?this.PRGRAM=t.PRGNVRAMByteLength/1024+"kb of PRG-NVRAM":t.PRGRAMByteLength&&(this.PRGRAM=t.PRGRAMByteLength/1024+"kb of PRG-RAM"),t.CHRRAMByteLength&&t.CHRNVRAMByteLength?this.CHRRAM=(t.CHRRAMByteLength+t.CHRNVRAMByteLength)/1024+"kb of combined CHR-RAM/NVRAM":t.CHRNVRAMByteLength?this.CHRRAM=t.CHRNVRAMByteLength/1024+"kb of CHR-NVRAM":t.CHRRAMByteLength&&(this.CHRRAM=t.CHRRAMByteLength/1024+"kb of CHR-RAM"),this.consoleType=R[t.consoleType],t.consoleType>0&&this.warn(`Unsupported console type (${this.consoleType})`)}serialize(){return{name:this.name,format:this.format,consoleType:this.consoleType,tvSystem:this.tvSystem,mapper:this.mapper,PRGROM:this.PRGROM,CHRROM:this.CHRROM,scrolling:this.scrolling,SRAM:this.SRAM,PRGRAM:this.PRGRAM,CHRRAM:this.CHRRAM,misc:this.misc}}}class A{constructor(){this.file=new h,this.metadata=new P,this.cartridge=new a}reset(){this.file=new h,this.metadata=new P,this.cartridge=new a}get name(){return this.metadata.name}get supported(){return this.metadata.supported}get valid(){return this.metadata.valid}load(t){return this.reset(),new Promise(((s,e)=>{if(t)if(this.metadata.parseFilename(t.name),t.size){const i=new FileReader;i.onabort=()=>e(new DOMException),i.onerror=()=>e(i.error||new Error),i.onload=()=>{i.result&&"object"==typeof i.result?s(i.result):e(new Error)},i.readAsArrayBuffer(t)}else e(new Error("File is empty"));else e(new DOMException)})).then((t=>{const s=new DataView(t).getUint32(0);if(1313166106===s)this.file=new p(t);else{if(1431193926!==s)throw new Error("Invalid format");this.file=new C(t)}if(!this.file.valid)throw new Error(`Unsupported format (${this.file.format})`);return this.metadata.load(this.file),this.cartridge=d.create(this.file.mapperNumber),this.cartridge.load(this.file,t),this})).catch((t=>(t instanceof DOMException?this.metadata.error("Loading aborted"):t.message?this.metadata.error(t.message):this.metadata.error("Loading failed"),this.cartridge=new a,this)))}unload(){return this.reset(),Promise.resolve(this)}}const b=Object.freeze({EMPTY:"Empty",JOYPAD:"Joypad",ZAPPER:"Zapper"}),y=Object.freeze({NONE:"None",KEYBOARD:"Keyboard",MOUSE:"Mouse"});class B{constructor(){this.strobing=!1}get type(){return b.EMPTY}get device(){return y.NONE}get empty(){return this.type===b.EMPTY}get present(){return this.type!==b.EMPTY}read(){return this.strobing&&this.strobe(),0}write(t){this.strobing&&this.strobe(),this.strobing=0!==t}strobe(){}}const M=Object.freeze({a:0,b:1,select:2,start:3,up:4,down:5,left:6,right:7});class O extends B{constructor(){super(),this.states=Object.seal(new Array(8).fill(0)),this.data=[],this.buttonHandlers=this.states.map(((t,s,e)=>t=>{e[s]=t?1:0}))}get type(){return b.JOYPAD}read(){super.read();const t=this.data.shift();return void 0!==t?t:1}strobe(){this.data=[...this.states]}getButtonHandler(t){const s=M[t];if(null!=s)return this.buttonHandlers[s];throw new Error(`'${t}' is not a valid button name`)}pressButton(t,s){this.getButtonHandler(t)(s)}}const N=Object.freeze({Backspace:8,Tab:9,Enter:13,Shift:16,Ctrl:17,Alt:18,Pause:19,Escape:27,Space:32,"Page-up":33,"Page-down":34,End:35,Home:36,Left:37,Up:38,Right:39,Down:40,Insert:45,Delete:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,"Numpad-0":96,"Numpad-1":97,"Numpad-2":98,"Numpad-3":99,"Numpad-4":100,"Numpad-5":101,"Numpad-6":102,"Numpad-7":103,"Numpad-8":104,"Numpad-9":105,Multiply:106,Add:107,Subtract:109,"Decimal-point":110,Divide:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,";":186,"=":187,",":188,"-":189,".":190,"/":191,"`":192,"[":219,"\\":220,"]":221,"'":222});var w=Object.freeze({__proto__:null,Keyboard:class extends O{constructor(t){super(),this.keyHandlers={},this.assignedKeys={},t&&this.assignKeys(t),"undefined"!=typeof window&&(window.addEventListener("keydown",(t=>this.pressKey(t,!0))),window.addEventListener("keyup",(t=>this.pressKey(t,!1))))}get device(){return y.KEYBOARD}assignKeys(t){Object.entries(t).forEach((([t,s])=>this.assignKey(t,s)))}assignKey(t,s){const e=this.getButtonHandler(t);Object.entries(this.keyHandlers).forEach((([t,s])=>{s===e&&delete this.keyHandlers[t]})),s in N&&(this.assignedKeys[t]=s,this.keyHandlers[N[s]]=e)}pressKey(t,s){const e=t.keyCode||t.which,i=this.keyHandlers[e];"function"==typeof i&&(i(s),t.preventDefault())}getAssignedKey(t){return this.assignedKeys[t]||""}}});class S{constructor(){this.controllers=Object.seal({1:new B,2:new B})}get 1(){return this.controllers[1]}get 2(){return this.controllers[2]}insert(t,s=1){this.controllers[s]=t}remove(t){this.controllers[t]=new B}read(t){return 16406===t?64+this.controllers[1].read():16407===t?64+this.controllers[2].read():t>>>8&224}write(t,s){if(0===s||1===s)this.controllers[1].write(s),this.controllers[2].write(s);else{const t=1&s?1:0;this.controllers[1].write(t),this.controllers[2].write(t)}}}const L=new Uint32Array([4283716692,4285799936,4287631368,4287103024,4284743748,4281335900,4278191188,4278196284,4278200864,4278204936,4278206464,4278205440,4282135040,4278190080,4278190080,4278190080,4288190104,4291054600,4293669424,4293140060,4289729672,4284748960,4280296088,4278205560,4278213204,4278219304,4278221832,4280841728,4286080512,4278190080,4278190080,4278190080,4293717740,4293696076,4293688440,4293681840,4293678308,4290009324,4284771052,4280322260,4278233760,4278240372,4280340556,4285320248,4291605560,4282137660,4278190080,4278190080,4293717740,4293708968,4293704892,4293702356,4293701356,4292128492,4289770732,4287677668,4286108364,4286111412,4287685288,4290044568,4293187232,4288717472,4278190080,4278190080]);var E=Object.freeze({__proto__:null,cssColors:["#545454","#001E74","#081090","#300088","#440064","#5C0030","#540400","#3C1800","#202A00","#083A00","#004000","#003C00","#00323C","#000000","#000000","#000000","#989698","#084CC4","#3032EC","#5C1EE4","#8814B0","#A01464","#982220","#783C00","#545A00","#287200","#087C00","#007628","#006678","#000000","#000000","#000000","#ECEEEC","#4C9AEC","#787CEC","#B062EC","#E454EC","#EC58B4","#EC6A64","#D48820","#A0AA00","#74C400","#4CD020","#38CC6C","#38B4CC","#3C3C3C","#000000","#000000","#ECEEEC","#A8CCEC","#BCBCEC","#D4B2EC","#ECAEEC","#ECAED4","#ECB4B0","#E4C490","#CCD278","#B4DE78","#A8E290","#98E2B4","#A0D6E4","#A0A2A0","#000000","#000000"],pxlColors:L});class v{constructor(t,s){this.width=t,this.height=s,this.frame=new ImageData(t,s),this.image=new ImageData(t,s),this.data=new Uint32Array(this.image.data.buffer)}setFrame(){this.frame=this.image,this.image=new ImageData(this.width,this.height),this.data=new Uint32Array(this.image.data.buffer)}writePixels(t,s,e){this.data.set(e,s*this.width+t)}}const{cssColors:T,pxlColors:I}=E,D=256,k=240;class X{constructor(){this.canvas=null,this.context=null,this.layers=[this.sprBehindLayer=new v(264,256),this.bkgLayer=new v(D,k),this.sprBeforeLayer=new v(264,256)],this.offCanvas=null,this.offContext=null,this.scheduled=0}connect(t){if("CANVAS"===t.nodeName)return this.canvas=t;throw new TypeError("VideoOutput.connect() expects a <CANVAS> element but received <"+t.nodeName+"> instead.")}disconnect(){const t=this.canvas;return this.canvas=null,t}get connected(){return!!this.canvas}get disconnected(){return!this.canvas}start(){this.canvas&&((this.context=this.canvas.getContext("2d",{alpha:!1}))&&(this.context.imageSmoothingEnabled=!1),this.offCanvas=document.createElement("canvas"),this.offCanvas.width=D,this.offCanvas.height=k,(this.offContext=this.offCanvas.getContext("2d",{alpha:!0}))&&(this.offContext.imageSmoothingEnabled=!1))}stop(){this.canvas&&(window.cancelAnimationFrame(this.scheduled),this.context=null,this.offCanvas&&(this.offCanvas.remove(),this.offCanvas=null,this.offContext=null))}get colors(){return I}drawImage(t){if(this.canvas){const s=this.canvas.width,e=this.canvas.height,i=this.context,h=this.offCanvas,r=this.offContext;i&&h&&r&&(i.fillStyle=T[t],i.fillRect(0,0,s,e),this.layers.forEach((t=>{t.setFrame(),r.putImageData(t.frame,0,0),i.drawImage(h,0,0,D,k,0,0,s,e)})))}}}const H=367,x=24;class U{constructor(t){this.buffers=new Array(x).fill(null).map((()=>new AudioBuffer({length:H,sampleRate:t}))),this.readyBuffer=this.writeBuffer=this.buffers[0],this.nextReadyIndex=this.nextWriteIndex=1,this.data=this.writeBuffer.getChannelData(0),this.index=0,this.duration=H/t,this.onnewbufferready=void 0,this.onbufferunderrun=void 0,this.onbufferoverrun=void 0}reset(){this.readyBuffer=this.writeBuffer=this.buffers[0],this.nextReadyIndex=this.nextWriteIndex=1,this.initChannelData()}initChannelData(){this.data=this.writeBuffer.getChannelData(0),this.index=0}get length(){return H}get buffersCount(){return x}get readyBuffersCount(){const t=this.nextWriteIndex-this.nextReadyIndex;return t<0?t+x:t}get usage(){return(this.readyBuffersCount+this.index/H)/x}get ready(){return this.nextReadyIndex!==this.nextWriteIndex}get halfFull(){return this.readyBuffersCount>=12}shift(){if(!this.ready){const t=this.index,s=t&&this.data[t-1];this.data.fill(s,t),this.rotateWriteBuffer(),this.data=this.writeBuffer.getChannelData(0),this.data.fill(s,0,t),"function"==typeof this.onbufferunderrun&&this.onbufferunderrun((t/H-1)*this.duration)}const t=this.readyBuffer;return this.rotateReadyBuffer(),t}writeSample(t){this.data[this.index++]=t,this.index===H&&(1===this.usage&&"function"==typeof this.onbufferoverrun&&this.onbufferoverrun(this),this.rotateWriteBuffer(),this.ready?(this.initChannelData(),"function"==typeof this.onnewbufferready&&this.onnewbufferready(this)):(this.rotateWriteBuffer(),this.initChannelData()))}rotateWriteBuffer(){let t=this.nextWriteIndex;this.writeBuffer=this.buffers[t++],this.nextWriteIndex=t<x?t:0}rotateReadyBuffer(){let t=this.nextReadyIndex;this.readyBuffer=this.buffers[t++],this.nextReadyIndex=t<x?t:0}}const Y=44100,V=1/12;let G;class z{constructor(){this.buffer=new U(Y),this.buffer.onbufferunderrun=t=>this.decreaseSpeed(t),this.buffer.onbufferoverrun=t=>{do{this.transfer(t,this.context)}while(!this.healthy)},this.gainNode=null,this.volumeValue=1,this.next=0,this.lockedUntil=1/0,this.speedAdjustment=1}get context(){return G||(G=new AudioContext({sampleRate:Y}),G.suspend()),G}get destination(){return this.gainNode||(this.gainNode=this.context.createGain(),this.gainNode.gain.value=this.volumeValue,this.gainNode.connect(this.context.destination)),this.gainNode}get volume(){return this.volumeValue}set volume(t){this.volumeValue=Math.min(1,Math.abs(t)),this.gainNode&&(this.gainNode.gain.value=this.volumeValue)}get buffered(){return this.next-this.context.currentTime}get healthy(){return this.buffered>=V}get sampleRate(){return Y}start(){const t=this.context;this.lockedUntil=1/0,this.buffer.reset(),this.buffer.onnewbufferready=s=>{if(s.halfFull){for(s.onnewbufferready=s=>{this.healthy&&!s.halfFull||this.transfer(s,t)},t.resume(),this.next=t.currentTime;!this.healthy;)this.transfer(s,t);this.lockedUntil=this.next}}}stop(){setTimeout((()=>this.context.suspend()),1e3*this.buffered)}writeSample(t){this.buffer.writeSample(t)}transfer(t,s){const e=s.createBufferSource(),i=t.shift();e.buffer=i;let h=this.next,r=h-s.currentTime;if(r<V)e.onended=()=>{this.healthy&&!t.halfFull||this.transfer(t,s)},r<0&&(h=s.currentTime);else if(r>.25)return;e.connect(this.destination),e.start(h),this.next=h+i.duration,r>2*V&&this.increaseSpeed((1-2*V/r)/10)}increaseSpeed(t){G.currentTime>=this.lockedUntil&&(this.speedAdjustment<1&&(this.speedAdjustment=Math.min(this.speedAdjustment*(1+t),1)),this.lockedUntil=this.next)}decreaseSpeed(t){G.currentTime>=this.lockedUntil&&(this.speedAdjustment*=1+t,this.lockedUntil=this.next)}}const F=[7,6,2,8,3,3,5,5,3,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,3,2,2,2,3,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,6,6,2,8,3,3,5,5,4,2,2,2,5,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,6,2,6,4,4,4,4,2,5,2,5,5,5,5,5,2,6,2,6,3,3,3,3,2,2,2,2,4,4,4,4,2,5,2,5,4,4,4,4,2,4,2,4,4,4,4,4,2,6,2,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7,2,6,3,8,3,3,5,5,2,2,2,2,4,4,6,6,2,5,2,8,4,4,6,6,2,4,2,7,4,4,7,7];class K extends s{constructor(t){super(),this.bus=t,this.ram=new Uint8Array(2048),this.stack=this.ram.subarray(256,512),this.nmiVector=()=>0,this.resetVector=()=>0,this.irqVector=()=>0,this.A=0,this.X=0,this.Y=0,this.P=48,this.SP=0,this.PC=0,this.addressLookup=[this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.abs,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imp,this.indX,this.imp,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.ind,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroY,this.zeroY,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absY,this.absY,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroY,this.zeroY,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absY,this.absY,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX,this.imm,this.indX,this.imm,this.indX,this.zero,this.zero,this.zero,this.zero,this.imp,this.imm,this.imp,this.imm,this.abs,this.abs,this.abs,this.abs,this.rel,this.indY,this.imp,this.indY,this.zeroX,this.zeroX,this.zeroX,this.zeroX,this.imp,this.absY,this.imp,this.absY,this.absX,this.absX,this.absX,this.absX].map((t=>t.bind(this))),this.instructionLookup=[this.BRK,this.ORA,this.KIL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.PHP,this.ORA,this.AXL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.BPL,this.ORA,this.KIL,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.CLC,this.ORA,this.NOP,this.NOP,this.NOP,this.ORA,this.ASL,this.NOP,this.JSR,this.AND,this.KIL,this.NOP,this.BIT,this.AND,this.ROL,this.NOP,this.PLP,this.AND,this.RXL,this.NOP,this.BIT,this.AND,this.ROL,this.NOP,this.BMI,this.AND,this.KIL,this.NOP,this.NOP,this.AND,this.ROL,this.NOP,this.SEC,this.AND,this.NOP,this.NOP,this.NOP,this.AND,this.ROL,this.NOP,this.RTI,this.EOR,this.KIL,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.PHA,this.EOR,this.LXR,this.NOP,this.JMP,this.EOR,this.LSR,this.NOP,this.BVC,this.EOR,this.KIL,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.CLI,this.EOR,this.NOP,this.NOP,this.NOP,this.EOR,this.LSR,this.NOP,this.RTS,this.ADC,this.KIL,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.PLA,this.ADC,this.RXR,this.NOP,this.JMP,this.ADC,this.ROR,this.NOP,this.BVS,this.ADC,this.KIL,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.SEI,this.ADC,this.NOP,this.NOP,this.NOP,this.ADC,this.ROR,this.NOP,this.NOP,this.STA,this.NOP,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.DEY,this.NOP,this.TXA,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.BCC,this.STA,this.KIL,this.NOP,this.STY,this.STA,this.STX,this.NOP,this.TYA,this.STA,this.TXS,this.NOP,this.NOP,this.STA,this.NOP,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.TAY,this.LDA,this.TAX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.BCS,this.LDA,this.KIL,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.CLV,this.LDA,this.TSX,this.NOP,this.LDY,this.LDA,this.LDX,this.NOP,this.CPY,this.CMP,this.NOP,this.NOP,this.CPY,this.CMP,this.DEC,this.NOP,this.INY,this.CMP,this.DEX,this.NOP,this.CPY,this.CMP,this.DEC,this.NOP,this.BNE,this.CMP,this.KIL,this.NOP,this.NOP,this.CMP,this.DEC,this.NOP,this.CLD,this.CMP,this.NOP,this.NOP,this.NOP,this.CMP,this.DEC,this.NOP,this.CPX,this.SBC,this.NOP,this.NOP,this.CPX,this.SBC,this.INC,this.NOP,this.INX,this.SBC,this.NOP,this.NOP,this.CPX,this.SBC,this.INC,this.NOP,this.BEQ,this.SBC,this.KIL,this.NOP,this.NOP,this.SBC,this.INC,this.NOP,this.SED,this.SBC,this.NOP,this.NOP,this.NOP,this.SBC,this.INC,this.NOP].map((t=>t.bind(this))),this.cycle=0,this.opcode=0,this.operand=0}powerOn(){this.cycle=0;const t=this.bus.game.cartridge;return this.nmiVector=()=>t.cpuRead(65530)+256*t.cpuRead(65531),this.resetVector=()=>t.cpuRead(65532)+256*t.cpuRead(65533),this.irqVector=()=>t.cpuRead(65534)+256*t.cpuRead(65535),this.A=0,this.X=0,this.Y=0,this.P=52,this.SP=253,this.PC=this.resetVector(),super.powerOn()}powerOff(){return super.powerOff()}reset(){this.doReset()}doInstructions(t){if(this.cycle<t){const s=this.bus.apu;let e;do{e=this.cycle,this.doInstruction(),s.doCycles(this.cycle-e)}while(this.cycle<t)}}doInstruction(){const t=this.opcode=this.read(this.PC++);this.operand=this.read(this.PC++),this.instructionLookup[t](this.addressLookup[t]),this.cycle+=F[t]}doNMI(){this.pushWord(this.PC),this.pushByte(-17&this.P),this.PC=this.nmiVector(),this.cycle+=7}doReset(){this.SP=W(this.SP+3),this.P|=4,this.PC=this.resetVector(),this.cycle+=7}doIRQ(){4&this.P||(this.pushWord(this.PC),this.pushByte(-17&this.P),this.PC=this.irqVector(),this.cycle+=7)}read(t){return t<2048?this.ram[t]:t<8192?this.ram[2047&t]:t<16408?t<16384?this.bus.ppu.read(t):t>=16406?this.bus.controllers.read(t):this.bus.apu.read(t):this.bus.game.cartridge.cpuRead(t)}write(t,s){t<2048?this.ram[t]=s:t<8192?this.ram[2047&t]=s:t<16408?t<16384?this.bus.ppu.write(t,s):16404===t?(this.bus.ppu.doDMA(256*s),1&this.cycle?this.cycle+=513:this.cycle+=514):16406===t?this.bus.controllers.write(t,s):this.bus.apu.write(t,s):this.bus.game.cartridge.cpuWrite(t,s)}pushByte(t){const s=this.SP;this.stack[s]=t,this.SP=s>0?s-1:255}pushWord(t){this.pushByte(t>>8),this.pushByte(255&t)}pullByte(){return this.stack[this.SP=W(this.SP+1)]}pullWord(){return this.pullByte()+256*this.pullByte()}get Carry(){return(1&this.P)>0}get Zero(){return(2&this.P)>0}get Interrupt(){return(4&this.P)>0}get Decimal(){return(8&this.P)>0}get Overflow(){return(64&this.P)>0}get Negative(){return(128&this.P)>0}set Carry(t){t?this.P|=1:this.P&=-2}set Zero(t){t?this.P|=2:this.P&=-3}set Interrupt(t){t?this.P|=4:this.P&=-5}set Decimal(t){t?this.P|=8:this.P&=-9}set Overflow(t){t?this.P|=64:this.P&=-65}set Negative(t){t?this.P|=128:this.P&=-129}ALU(t){if(t>255)for(this.Carry=!0;t>255;)t-=256;if(this.Zero=0===t,t<0)for(this.Negative=!0;t<0;)t+=256;else this.Negative=t>=128;return t}imp(t){return this.PC--,t}imm(){return this.PC-1}rel(){return this.cycle++,(t=this.operand)>127?t-256:t;var t}zero(){return this.operand}zeroX(){return W(this.operand+this.X)}zeroY(){return W(this.operand+this.Y)}readWord(){return this.operand+=256*this.read(this.PC++)}abs(){return this.readWord()}absX(){return this.operand+this.X>255&&this.cycle++,this.readWord()+this.X}absY(){return this.operand+this.Y>255&&this.cycle++,this.readWord()+this.Y}ind(){const t=this.readWord();return this.read(t)+256*this.read(t+1)}indX(){const t=W(this.operand+this.X);return this.read(t)+256*this.read(t+1)}indY(){const t=this.read(this.operand),s=this.read(this.operand+1);return t+this.Y>255&&this.cycle++,t+256*s+this.Y}BRK(t){this.pushWord(this.PC),this.pushByte(this.P),this.Interrupt=!0,this.PC=t(this.irqVector())}RTI(t){this.P=this.pullByte(),this.PC=t(this.pullWord())}JSR(t){this.pushWord(this.PC),this.PC=t()}RTS(t){this.PC=t(this.pullWord()+1)}JMP(t){this.PC=t()}BPL(t){this.Negative||(this.PC+=t())}BMI(t){this.Negative&&(this.PC+=t())}BVC(t){this.Overflow||(this.PC+=t())}BVS(t){this.Overflow&&(this.PC+=t())}BCC(t){this.Carry||(this.PC+=t())}BCS(t){this.Carry&&(this.PC+=t())}BNE(t){this.Zero||(this.PC+=t())}BEQ(t){this.Zero&&(this.PC+=t())}PHA(t){this.pushByte(t(this.A))}PHP(t){this.pushByte(t(this.P))}PLA(t){this.A=this.ALU(t(this.pullByte()))}PLP(t){this.P=t(this.pullByte())}CLC(t){t(this.Carry=!1)}CLD(t){t(this.Decimal=!1)}CLI(t){t(this.Interrupt=!1)}CLV(t){t(this.Overflow=!1)}SEC(t){t(this.Carry=!0)}SED(t){t(this.Decimal=!0)}SEI(t){t(this.Interrupt=!0)}TAX(t){t(this.X=this.ALU(this.A))}TXA(t){t(this.A=this.ALU(this.X))}TAY(t){t(this.Y=this.ALU(this.A))}TYA(t){t(this.A=this.ALU(this.Y))}TSX(t){t(this.X=this.ALU(this.SP))}TXS(t){t(this.SP=this.X)}LDA(t){this.A=this.ALU(this.read(t()))}LDX(t){this.X=this.ALU(this.read(t()))}LDY(t){this.Y=this.ALU(this.read(t()))}STA(t){this.write(t(),this.A)}STX(t){this.write(t(),this.X)}STY(t){this.write(t(),this.Y)}ADC(t){this.add(this.A,this.read(t()))}SBC(t){this.add(this.A,255-this.read(t()))}add(t,s){const e=t+s+(this.Carry?1:0);this.Carry=!1,this.Overflow=((t^e)&(s^e)&128)>0,this.A=this.ALU(e)}ASL(t){const s=t(),e=this.read(s);this.write(s,this.ALU(2*e)),this.Carry=e>=128}AXL(t){const s=t(this.A);this.A=this.ALU(2*s),this.Carry=s>=128}LSR(t){const s=t(),e=this.read(s);this.write(s,this.ALU(e>>>1)),this.Carry=(1&e)>0}LXR(t){const s=t(this.A);this.A=this.ALU(s>>>1),this.Carry=(1&s)>0}ROL(t){const s=this.Carry?1:0,e=t(),i=this.read(e);this.write(e,this.ALU(2*i+s)),this.Carry=i>=128}RXL(t){const s=this.Carry?1:0,e=t(this.A);this.A=this.ALU(2*e+s),this.Carry=e>=128}ROR(t){const s=this.Carry?128:0,e=t(),i=this.read(e);this.write(e,this.ALU((i>>>1)+s)),this.Carry=(1&i)>0}RXR(t){const s=this.Carry?128:0,e=t(this.A);this.A=this.ALU((e>>>1)+s),this.Carry=(1&e)>0}INC(t){const s=t();this.write(s,this.ALU(this.read(s)+1))}DEC(t){const s=t();this.write(s,this.ALU(this.read(s)-1))}INX(t){this.X=this.ALU(t(this.X)+1)}DEX(t){this.X=this.ALU(t(this.X)-1)}INY(t){this.Y=this.ALU(t(this.Y)+1)}DEY(t){this.Y=this.ALU(t(this.Y)-1)}BIT(t){const s=this.read(t());s>=128?(this.Negative=!0,this.Overflow=s>=192):(this.Negative=!1,this.Overflow=s>=64),this.Zero=!(this.A&s)}CMP(t){this.compare(this.A,this.read(t()))}CPX(t){this.compare(this.X,this.read(t()))}CPY(t){this.compare(this.Y,this.read(t()))}compare(t,s){this.ALU(t+(256-s)),this.Carry=t>=s}ORA(t){this.A=this.ALU(this.A|this.read(t()))}AND(t){this.A=this.ALU(this.A&this.read(t()))}EOR(t){this.A=this.ALU(this.A^this.read(t()))}NOP(t){t()}KIL(t){t(),this.doReset()}}function W(t){return t>255?t-256:t}const j=[10,254,20,2,40,4,80,6,160,8,60,10,14,12,26,14,12,16,24,18,48,20,96,22,192,24,72,26,16,28,32,30];class q extends class{constructor(){this.timerCycle=0,this.timerPeriod=0}reset(){this.timer=0,this.timerCycle=0}get timer(){return this.timerPeriod}set timer(t){const s=this.timerPeriod;this.timerPeriod=s>255?(1792&s)+t:t}}{constructor(){super(),this.disabled=!0,this.lengthCounter=0,this.lengthCounterHalt=!1}reset(){super.reset(),this.enabled=!1,this.length=0}get enabled(){return this.lengthCounter>0}set enabled(t){(this.disabled=!t)&&(this.lengthCounter=0)}get length(){return this.lengthCounter}set length(t){this.disabled||(this.lengthCounter=j[(248&t)>>>3])}doHalf(){this.lengthCounter>0&&!this.lengthCounterHalt&&this.lengthCounter--}}class Q extends q{constructor(){super(),this.constantVolume=0,this.envelopeEnabled=!0,this.envelopeReset=!1,this.envelopeCycle=0,this.envelopePeriod=0,this.envelopeVolume=0,this.envelopeLoop=!1}reset(){super.reset(),this.volume=0,this.envelopeCycle=0,this.envelopeVolume=0}get volume(){return this.envelopeEnabled?this.envelopeVolume:this.constantVolume}set volume(t){t>15?(this.lengthCounterHalt=this.envelopeLoop=0!=(32&t),this.envelopeEnabled=0==(16&t),this.envelopePeriod=this.constantVolume=15&t):(this.lengthCounterHalt=!1,this.envelopeLoop=!1,this.envelopeEnabled=!0,this.envelopePeriod=t,this.constantVolume=t)}get length(){return super.length}set length(t){this.envelopeReset=!0,super.length=t}doQuarter(){this.envelopeReset?(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume=15,this.envelopeReset=!1):this.envelopeCycle>0?this.envelopeCycle--:(this.envelopeCycle=this.envelopePeriod,this.envelopeVolume>0?this.envelopeVolume--:this.envelopeLoop&&(this.envelopeVolume=15))}}class J extends q{constructor(){super(),this.linearCounter=0,this.linearCounterMax=0,this.linearCounterReset=!1,this.linearCounterControl=!1}reset(){super.reset(),this.counter=0,this.linearCounter=0}get counter(){return this.linearCounter}set counter(t){t>=128?(this.lengthCounterHalt=!0,this.linearCounterControl=!0,this.linearCounterMax=t-128):(this.lengthCounterHalt=!1,this.linearCounterControl=!1,this.linearCounterMax=t)}get length(){return super.length}set length(t){this.linearCounterReset=!0,super.length=t}doQuarter(){this.linearCounterReset?this.linearCounter=this.linearCounterMax:this.linearCounter>0&&this.linearCounter--,this.linearCounterControl||(this.linearCounterReset=!1)}}class Z extends Q{constructor(t){super(),this.negateMode=t,this.sweepEnabled=!1,this.sweepReset=!1,this.sweepCycle=0,this.sweepPeriod=0,this.sweepNegate=!1,this.sweepShift=0}reset(){super.reset(),this.sweep=0,this.sweepCycle=0}get sweep(){const t=this.timer,s=t>>>this.sweepShift;return t+(this.sweepNegate?1===this.negateMode?~s:-s:s)}set sweep(t){this.sweepEnabled=0!=(128&t),this.sweepPeriod=(112&t)>>>4,this.sweepNegate=0!=(8&t),this.sweepShift=7&t,this.sweepReset=!0}doHalf(){this.sweepCycle>0?this.sweepCycle--:(this.sweepEnabled&&this.sweepShift&&this.timer>=8&&this.sweep<2048&&(this.timerPeriod=this.sweep),this.sweepCycle=this.sweepPeriod),this.sweepReset&&(this.sweepCycle=this.sweepPeriod,this.sweepReset=!1),super.doHalf()}}const _=[[0,0,0,0,0,0,0,1],[0,0,0,0,0,0,1,1],[0,0,0,0,1,1,1,1],[1,1,1,1,1,1,0,0]];class $ extends Z{constructor(t){super(t),this.dutyCycle=0,this.duty=[0,0,0,0,0,0,0,0]}get volume(){return super.volume}set volume(t){this.duty=t>63?_[(192&t)>>>6]:_[0],super.volume=t}get length(){return super.length}set length(t){this.dutyCycle=0,this.timerPeriod=255&this.timerPeriod|(7&t)<<8,super.length=t}write(t,s){switch(t){case 16384:case 16388:this.volume=s;break;case 16385:case 16389:this.sweep=s;break;case 16386:case 16390:this.timer=s;break;case 16387:case 16391:this.length=s}}doCycle(){--this.timerCycle<=0&&(this.timerCycle=this.timerPeriod+1,this.dutyCycle++,this.dutyCycle>=8&&(this.dutyCycle=0))}get output(){return this.enabled&&this.timer>=8&&this.sweep<2048?this.volume*this.duty[this.dutyCycle]:0}}const tt=[15,14,13,12,11,10,9,8,7,6,5,4,3,2,1,0,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];class st extends J{constructor(){super(),this.phase=0}reset(){super.reset(),this.phase=0}get length(){return super.length}set length(t){this.timerPeriod=255&this.timerPeriod|(7&t)<<8,super.length=t}write(t,s){switch(t){case 16392:this.counter=s;break;case 16394:this.timer=s;break;case 16395:this.length=s}}doCycle(){if(this.timerCycle-=2,this.timerCycle<=0&&(this.timerCycle=this.timer+1,this.length&&this.counter&&this.timer>3)){const t=this.phase+1;this.phase=t<32?t:0}}get output(){return tt[this.phase]}}const et=[4,8,16,32,64,96,128,160,202,254,380,508,762,1016,2034,4068];class it extends Q{constructor(){super(),this.timerMode=!1,this.shiftRegister=1}get timer(){return this.timerPeriod}set timer(t){t>15?(this.timerMode=t>=128,this.timerPeriod=et[15&t]):(this.timerMode=!1,this.timerPeriod=et[t])}write(t,s){switch(t){case 16396:this.volume=s;break;case 16398:this.timer=s;break;case 16399:this.length=s}}doCycle(){if(--this.timerCycle<=0){this.timerCycle=this.timerPeriod+1;const t=this.shiftRegister;let s=1&t;this.timerMode?s^=t>>>6&1:s^=t>>>1&1,this.shiftRegister=t>>>1|s<<14}}get output(){return!this.enabled||1&this.shiftRegister?0:this.volume}}const ht=[428,380,340,320,286,254,226,214,190,160,142,128,106,84,72,54];class rt{constructor(t){this.bus=t,this.timerCycle=0,this.timerPeriod=ht[0],this.sampleBuffer=-1,this.sampleAddress=49152,this.sampleLength=1,this.sampleLeft=0,this.sampleLoop=!1,this.shiftRegister=-1,this.shiftRegisterCycle=0,this.irqEnabled=!1,this.irq=!1,this.output=0}reset(){this.timerCycle=0,this.enabled=!1,this.rate=0,this.load=0,this.address=0,this.length=0}get enabled(){return this.sampleLeft>0}set enabled(t){t?0===this.sampleLeft&&(this.sampleLeft=this.sampleLength):this.sampleLeft=0,this.irq=!1}doIRQ(){this.irq=!0,this.bus.cpu.doIRQ()}get rate(){return this.timerPeriod}set rate(t){t>15?(this.irqEnabled=0!=(128&t),this.sampleLoop=0!=(64&t),this.timerPeriod=ht[15&t]):(this.irqEnabled=!1,this.sampleLoop=!1,this.timerPeriod=ht[t]),this.irqEnabled||(this.irq=!1)}get load(){return this.output}set load(t){this.output=t>=128?t-128:t}get address(){return this.sampleAddress}set address(t){this.sampleAddress=49152+64*t}get length(){return this.sampleLength}set length(t){this.sampleLength=16*t+1}write(t,s){switch(t){case 16400:this.rate=s;break;case 16401:this.load=s;break;case 16402:this.address=s;break;case 16403:this.length=s}}doCycle(){const t=this.timerCycle-2;t<=0?(this.timerCycle=this.timerPeriod,this.updateSampleBuffer(),this.updateShiftRegister(),this.updateOutput()):this.timerCycle=t}updateSampleBuffer(){if(this.sampleBuffer<0&&this.enabled){let t=this.sampleLeft,s=this.sampleLength;const e=s-t;this.sampleBuffer=this.bus.cpu.read(this.sampleAddress+e),--t>0?this.sampleLeft=t:this.sampleLoop?this.sampleLeft=s:(this.sampleLeft=0,this.irqEnabled&&this.doIRQ())}}updateShiftRegister(){--this.shiftRegisterCycle<=0&&(this.shiftRegisterCycle=8,this.shiftRegister=this.sampleBuffer,this.sampleBuffer=-1)}updateOutput(){const t=this.shiftRegister;if(t>=0){const s=this.output;1&t?s<=125&&(this.output=s+2):s>=2&&(this.output=s-2),this.shiftRegister=t>>>1}}}class nt extends s{constructor(t){super(),this.bus=t,this.pulse1=new $(1),this.pulse2=new $(2),this.triangle=new st,this.noise=new it,this.dmc=new rt(t),this.status=0,this.irqDisabled=!1,this.irq=!1,this.counterMode=0,this.toggle=!0,this.cycle=0,this.resetDelay=0,this.cyclesPerSample=0,this.cyclesUntilSample=1/0}powerOn(){return this.bus.audio.start(),this.cyclesPerSample=893415/this.bus.audio.sampleRate,this.cyclesUntilSample=this.cyclesPerSample*this.bus.audio.speedAdjustment,super.powerOn()}powerOff(){return this.bus.audio.stop(),super.powerOff()}reset(){this.pulse1.reset(),this.pulse2.reset(),this.triangle.reset(),this.noise.reset(),this.dmc.reset(),this.counter=0,this.irq=!1}doIRQ(){this.irq=!0,this.bus.cpu.doIRQ()}get status(){let t=(this.pulse1.enabled?1:0)+(this.pulse2.enabled?2:0)+(this.triangle.enabled?4:0)+(this.noise.enabled?8:0)+(this.dmc.enabled?16:0)+(this.dmc.irq?128:0)+(this.irq?64:0);return this.irq=!1,t}set status(t){t?(this.pulse1.enabled=!!(1&t),this.pulse2.enabled=!!(2&t),this.triangle.enabled=!!(4&t),this.noise.enabled=!!(8&t),this.dmc.enabled=!!(16&t)):(this.pulse1.enabled=!1,this.pulse2.enabled=!1,this.triangle.enabled=!1,this.noise.enabled=!1,this.dmc.enabled=!1)}get counter(){return this.counterMode}set counter(t){t?(t>=128?(this.counterMode=128,this.irqDisabled=t>=192,this.doQuarter(),this.doHalf()):(this.counterMode=0,this.irqDisabled=t>=64),this.irqDisabled&&(this.irq=!1)):(this.counterMode=0,this.irqDisabled=!1),this.resetDelay=2}get fourStepCounterMode(){return 0===this.counterMode}get fiveStepCounterMode(){return 128===this.counterMode}read(t){return 16405===t?this.status:0}write(t,s){t<=16387?this.pulse1.write(t,s):t<=16391?this.pulse2.write(t,s):t<=16395?this.triangle.write(t,s):t<=16399?this.noise.write(t,s):t<=16403?this.dmc.write(t,s):16405===t?this.status=s:16407===t&&(this.counter=s)}doCycles(t){for(;t--;)(this.toggle=!this.toggle)&&(this.resetDelay>0&&0==--this.resetDelay&&(this.cycle=0),this.doCycle())}doCycle(){const t=this.cycle++;t<=7457?7457===t&&this.doQuarter():t<=14914?14914===t&&(this.doQuarter(),this.doHalf()):t<=22371?22371===t&&this.doQuarter():t>=29828&&(29828===t&&this.fourStepCounterMode?(this.doQuarter(),this.doHalf(),this.irqDisabled||this.doIRQ(),this.cycle=0):37281===t&&(this.doQuarter(),this.doHalf(),this.cycle=0)),this.pulse1.doCycle(),this.pulse2.doCycle(),this.triangle.doCycle(),this.noise.doCycle(),this.dmc.doCycle(),--this.cyclesUntilSample<=0&&(this.doSample(),this.cyclesUntilSample+=this.cyclesPerSample*this.bus.audio.speedAdjustment)}doQuarter(){this.pulse1.doQuarter(),this.pulse2.doQuarter(),this.triangle.doQuarter(),this.noise.doQuarter()}doHalf(){this.pulse1.doHalf(),this.pulse2.doHalf(),this.triangle.doHalf(),this.noise.doHalf()}doSample(){const t=this.pulse1.output+this.pulse2.output,s=3*this.triangle.output+2*this.noise.output+this.dmc.output;this.bus.audio.writeSample(at[t]+ot[s])}}const at=new Float32Array(31);for(let t=0;t<31;t++)at[t]=95.52/(8128/t+100);const ot=new Float32Array(203);for(let t=0;t<203;t++)ot[t]=163.67/(24329/t+100);class lt extends s{constructor(t){super(),this.bus=t,this.ntsc=!0,this.vram=[new Uint8Array(1024),new Uint8Array(1024)],this.palette=[new Uint8Array(16),new Uint8Array(16)],this.addressIncrement=1,this.sprPatternTable=0,this.bkgPatternTable=0,this.sprite8x16=!1,this.nmiEnabled=!1,this.spriteHeight=8,this.grayscale=!1,this.showLeftMostBkg=!1,this.showLeftMostSpr=!1,this.showBackground=!1,this.showSprites=!1,this.emphasizeRed=!1,this.emphasizeGreen=!1,this.emphasizeBlue=!1,this.renderingEnabled=!1,this.spriteOverflow=!1,this.sprite0Hit=!1,this.vblank=!1,this.oamPrimary=new Uint8Array(256),this.oamAddress=0,this.oamSecondary=new Uint8Array(32),this.oamIndex=0,this.fineScrollX=0,this.fineScrollY=0,this.writeToggle=!1,this.addressBus=0,this.addressBuffer=0,this.readBuffer=0,this.bkgPixelsBuffer=new Uint32Array(16),this.sprPixelsBuffer=new Uint32Array(8),this.bkgLayer=this.bus.video.bkgLayer,this.sprLayer=this.bus.video.sprBeforeLayer,this.sprite0Layer=new Uint32Array(264),this.sprite0=!1}powerOn(){return this.control=0,this.mask=0,this.sprite0Hit=!1,this.OAMAddress=0,this.fineScrollX=0,this.fineScrollY=0,this.addressBus=0,this.addressBuffer=0,this.readBuffer=0,this.writeToggle=!1,this.ntsc="NTSC"===this.bus.game.metadata.tvSystem,this.bus.video.start(),super.powerOn()}powerOff(){return this.bus.video.stop(),super.powerOff()}reset(){this.control=0,this.mask=0,this.fineScrollX=0,this.fineScrollY=0,this.readBuffer=0,this.writeToggle=!1}doVBlank(){this.vblank=!0,this.nmiEnabled&&this.bus.cpu.doNMI()}endVBlank(){this.spriteOverflow=!1,this.sprite0Hit=!1,this.vblank=!1}doDMA(t){const s=this.bus.cpu;for(let e=0;e<256;e++)this.OAMData=s.read(t++)}set control(t){this.addressBuffer&=-3073,t?(this.addressBuffer|=(3&t)<<10,this.addressIncrement=4&t?32:1,this.sprPatternTable=8&t?4096:0,this.bkgPatternTable=16&t?4096:0,this.sprite8x16=!!(32&t),this.nmiEnabled=!!(128&t)):(this.addressIncrement=1,this.sprPatternTable=0,this.bkgPatternTable=0,this.sprite8x16=!1,this.nmiEnabled=!1),this.spriteHeight=this.sprite8x16?16:8}set mask(t){t?(this.grayscale=!!(1&t),this.showLeftMostBkg=!!(2&t),this.showLeftMostSpr=!!(4&t),this.showBackground=!!(8&t),this.showSprites=!!(16&t),this.emphasizeRed=!!(t&(this.ntsc?32:64)),this.emphasizeGreen=!!(t&(this.ntsc?64:32)),this.emphasizeBlue=!!(128&t),this.renderingEnabled=!!(24&t)):(this.grayscale=!1,this.showLeftMostBkg=!1,this.showLeftMostSpr=!1,this.showBackground=!1,this.showSprites=!1,this.emphasizeRed=!1,this.emphasizeGreen=!1,this.emphasizeBlue=!1,this.renderingEnabled=!1)}get status(){let t=(this.spriteOverflow?32:0)+(this.sprite0Hit?64:0)+(this.vblank?128:0);return this.vblank=!1,this.writeToggle=!1,t}set OAMAddress(t){this.oamAddress=t}get OAMData(){return this.oamPrimary[this.oamAddress]}set OAMData(t){this.oamPrimary[this.oamAddress++]=t,this.oamAddress>255&&(this.oamAddress=0)}set scroll(t){const s=this.writeToggle;let e=this.addressBuffer;s?(e&=3103,e|=(7&t)<<12,e|=(248&t)<<2,this.fineScrollY=7&t):(e&=32736,e|=t>>>3,this.fineScrollX=7&t),this.addressBuffer=e,this.writeToggle=!s}set address(t){const s=this.writeToggle;s?(this.addressBuffer=65280&this.addressBuffer|t,this.addressBus=this.addressBuffer):(t=(63&t)<<8,this.addressBuffer=255&this.addressBuffer|t),this.writeToggle=!s}get data(){const t=this.addressBus;let s;return s=t>=16128?this.readPalette(t):this.readBuffer,this.readBuffer=this.readData(t),this.addressBus=t+this.addressIncrement,s}set data(t){const s=this.addressBus;s>=16128?this.writePalette(s,t):this.writeData(s,t),this.addressBus=s+this.addressIncrement}read(t){switch(t>8199&&(t&=8199),t){case 8194:return this.status;case 8196:return this.OAMData;case 8199:return this.data;default:return 0}}write(t,s){switch(t>8199&&(t&=8199),t){case 8192:this.control=s;break;case 8193:this.mask=s;break;case 8195:this.OAMAddress=s;break;case 8196:this.OAMData=s;break;case 8197:this.scroll=s;break;case 8198:this.address=s;break;case 8199:this.data=s}}readData(t){const s=this.bus.game.cartridge;return s.ciramEnabled(t)?this.vram[s.ciramA10(t)][1023&t]:s.ppuRead(t)}writeData(t,s){const e=this.bus.game.cartridge;e.ciramEnabled(t)?this.vram[e.ciramA10(t)][1023&t]=s:e.ppuWrite(t,s)}get backdrop(){return this.palette[0][0]}get bkgPalette(){return this.palette[0]}get sprPalette(){return this.palette[1]}readPalette(t){return 3&t?this.palette[(16&t)>>>4][15&t]:this.backdrop}writePalette(t,s){s>63&&(s&=63),3&t?this.palette[(16&t)>>>4][15&t]=s:this.bkgPalette[15&t]=s}incrementX(){if(!this.renderingEnabled)return;let t=this.addressBus;31==(31&t)?(t&=32736,t^=1024):t++,this.addressBus=t}incrementY(){if(!this.renderingEnabled)return;let t=this.addressBus;if(t<28672)t+=4096,this.fineScrollY++;else{t-=28672;const s=992&t;928===s?(t&=3103,t^=2048):992===s?t&=64543:t+=32,this.fineScrollY=t>>>12}this.addressBus=t}resetX(){if(!this.renderingEnabled)return;let t=this.addressBus;t&=31712,t|=1055&this.addressBuffer,this.addressBus=t}resetY(){if(!this.renderingEnabled)return;let t=this.addressBus;t&=1055,t|=31712&this.addressBuffer,this.addressBus=t,this.fineScrollY=t>>>12}fetchNameTable(t){const s=8192+(4095&t);return this.readData(s)}fetchAttributeTable(t){const s=9152|3072&t|t>>>4&56|t>>>2&7;let e=0;return 2&t&&(e+=2),64&t&&(e+=4),this.readData(s)>>>e&3}fetchBkgPatternTable(t,s){const e=this.bkgPatternTable+16*t+s;return 256*this.readData(e)+this.readData(e+8)}fillBkgPixelsBuffer(t,s){this.bkgPixelsBuffer.copyWithin(0,8);const e=this.bkgPixelsBuffer.subarray(8,16);if(t){const i=this.bus.video.colors,h=4*s;for(let s=0;s<8;s++){const r=ut(t,s,!1);e[s]=r?i[this.bkgPalette[h+r]]:0}}else e.fill(0)}fetchTile(){if(!this.showBackground)return;const t=this.addressBus,s=this.fetchNameTable(t),e=this.fetchAttributeTable(t),i=this.fetchBkgPatternTable(s,this.fineScrollY);this.fillBkgPixelsBuffer(i,e)}fetchNullTile(){if(!this.showBackground)return;const t=this.addressBus,s=this.fetchNameTable(t);this.fetchAttributeTable(t),this.fetchBkgPatternTable(s,this.fineScrollY)}fetchNullNTs(){if(!this.showBackground)return;const t=this.addressBus;this.fetchNameTable(t),this.fetchNameTable(t)}renderTile(t,s){if(!this.showBackground)return;const e=this.fineScrollX,i=this.bkgPixelsBuffer.subarray(e,e+8);if(!this.sprite0Hit){const e=this.oamPrimary[0];if(e<s+8&&e+8>s){const s=this.oamPrimary[3];s<t+8&&s+8>t&&(this.sprite0Hit=this.sprite0Layer.subarray(t,t+8).some(((t,s)=>t&&i[s])))}}this.bkgLayer.writePixels(t,s,i)}clearSecondaryOAM(){this.oamSecondary.fill(255),this.oamIndex=0}evaluateSprites(t){const s=this.oamPrimary,e=this.oamSecondary,i=this.spriteHeight;let h=0,r=0,n=0;for(;this.oamAddress<256;){if(h=s[this.oamAddress],r=h+i,n=h,this.oamIndex<32){if(e[this.oamIndex]=h,t>=n&&t<r){0===this.oamAddress&&(this.sprite0=!0);for(let t=1;t<4;t++)e[this.oamIndex+t]=s[this.oamAddress+t];this.oamIndex+=4}}else if(t>=n&&t<r){this.spriteOverflow=!0;break}this.oamAddress+=4}this.oamIndex=0}fetchSprPatternTable(t,s){let e=this.sprPatternTable;this.sprite8x16&&(1&t?(e=4096,t&=254):e=0);const i=e+16*t+s;return 256*this.readData(i)+this.readData(i+8)}fillSprPixelsBuffer(t,s,e){const i=this.sprPixelsBuffer;if(t){const h=this.bus.video.colors,r=4*s;for(let s=0;s<8;s++){const n=ut(t,s,e);i[s]=n?h[this.sprPalette[r+n]]:0}}else i.fill(0);return i}fetchSprite(t){if(!this.showSprites)return;const s=this.addressBus;this.fetchNameTable(s),this.fetchAttributeTable(s),this.oamAddress=0;const e=this.oamSecondary,i=e[this.oamIndex++];let h=e[this.oamIndex++],r=e[this.oamIndex++];const n=e[this.oamIndex++];let a=t-i;r>=128&&(a=this.spriteHeight-a-1,r-=128);let o=!1;r>=64&&(o=!0,r-=64),r>=32?(this.sprLayer=this.bus.video.sprBehindLayer,r-=32):this.sprLayer=this.bus.video.sprBeforeLayer,r>3&&(r&=3),a>=8&&(a-=8,h++);const l=this.fetchSprPatternTable(h,a),d=this.fillSprPixelsBuffer(l,r,o);this.sprite0&&(this.sprite0Layer.set(d,n),this.sprite0=!1),this.sprLayer.writePixels(n,t+1,d)}fetchNullSprite(){if(!this.showSprites)return;const t=this.addressBus;this.fetchNameTable(t),this.fetchAttributeTable(t),this.fetchSprPatternTable(0,0)}printFrame(){this.bus.video.drawImage(this.backdrop)}}const dt=Object.freeze({0:0,256:1,32768:1,1:2,128:2,257:3,32896:3});function ut(t,s,e=!1){return e?dt[t>>s&257]:dt[t<<s&32896]}class ct extends s{constructor(){super(),this.fps=60,this.performance=1;let t=0,s=0,e=60;const i=()=>{this.performance=1e3/t,this.fps=e,t=0,s=0,e=60};this.addFrame=h=>{t+=performance.now()-h,++s>=e&&i()},this.dropFrame=()=>{--e<=s&&i()}}}const pt=1e3/60,ft=341/3,mt=29780.5;class Ct extends ct{constructor(t){super(),this.bus=t,this.firstLoop=this.firstLoop.bind(this),this.mainLoop=this.mainLoop.bind(this),this.runningLoop=0,this.lastTime=0,this.isPaused=!1}powerOn(){return this.coldBoot(),this.isPaused=!1,super.powerOn()}powerOff(){return cancelAnimationFrame(this.runningLoop),this.runningLoop=0,this.isPaused=!1,super.powerOff()}pause(){return this.isPaused?(this.runningLoop=requestAnimationFrame(this.firstLoop),this.isPaused=!1):(cancelAnimationFrame(this.runningLoop),this.runningLoop=0,this.isPaused=this.isPowered),this.isPaused}coldBoot(){this.doBoot(this.bus.cpu,this.bus.ppu),this.runningLoop=requestAnimationFrame(this.firstLoop)}firstLoop(t){this.runningLoop=requestAnimationFrame(this.mainLoop),this.lastTime=t,this.doFrame(this.bus.cpu,this.bus.ppu),this.addFrame(t)}mainLoop(t){this.runningLoop=requestAnimationFrame(this.mainLoop);let s=t-this.lastTime;if(this.lastTime=t,s>1e3)this.pause();else{for(;(s-=pt)>=pt;)this.skipFrame(this.bus.cpu,this.bus.ppu),this.dropFrame();this.doFrame(this.bus.cpu,this.bus.ppu),this.addFrame(t)}}doBoot(t,s){t.doInstructions(2279),s.vblank=!0,t.doInstructions(4757),s.vblank=!0,this.doVBlank(t,s),this.doPreRenderLine(t,s),t.cycle-=mt}doFrame(t,s){for(let e=0;e<240;e++)this.doScanline(t,s,e);s.printFrame(),this.doVBlank(t,s),this.doPreRenderLine(t,s),t.cycle-=mt}skipFrame(t,s){this.doVBlank(t,s),t.doInstructions(mt),t.cycle-=mt}doVBlank(t,s){t.doInstructions(27393.666666666668),s.doVBlank(),t.doInstructions(29667),s.endVBlank()}doScanline(t,s,e){const i=e*ft;let h=0;for(s.clearSecondaryOAM();h<64;)t.doInstructions(i+h/3),s.renderTile(h,e),s.fetchTile(),s.incrementX(),h+=8;for(s.evaluateSprites(e);h<248;)t.doInstructions(i+h/3),s.renderTile(h,e),s.fetchTile(),s.incrementX(),h+=8;for(t.doInstructions(i+h/3),s.renderTile(h,e),s.fetchNullTile(),s.incrementX(),s.incrementY(),s.resetX(),h+=8;h<320;)t.doInstructions(i+h/3),s.fetchSprite(e),h+=8;for(;h<336;)t.doInstructions(i+h/3),s.fetchTile(),s.incrementX(),h+=8;t.doInstructions(i+h/3),s.fetchNullNTs(),h+=4.5,t.doInstructions(i+h/3)}doPreRenderLine(t,s){const e=29667;let i=0;for(;i<248;)t.doInstructions(e+i/3),s.fetchNullTile(),s.incrementX(),i+=8;for(t.doInstructions(e+i/3),s.fetchNullTile(),s.incrementX(),s.incrementY(),s.resetX(),i+=8;i<280;)t.doInstructions(e+i/3),s.fetchNullSprite(),i+=8;for(;i<304;)t.doInstructions(e+i/3),s.fetchNullSprite(),s.resetY(),i+=8;for(;i<320;)t.doInstructions(e+i/3),s.fetchNullSprite(),i+=8;for(;i<336;)t.doInstructions(e+i/3),s.fetchTile(),s.incrementX(),i+=8;t.doInstructions(e+i/3),s.fetchNullNTs(),i+=4.5,t.doInstructions(e+i/3)}}class Rt extends e{constructor(){super(),this.game=new A,this.controllers=new S,this.video=new X,this.audio=new z,this.cpu=new K(this),this.apu=new nt(this),this.ppu=new lt(this),this.engine=new Ct(this)}get frontLED(){return this.isPowered?this.engine.isPaused?"paused":"on":"off"}}var gt={NES:Rt,Devices:w};t.Devices=w,t.NES=Rt,t.default=gt,Object.defineProperty(t,"__esModule",{value:!0})}));
//# sourceMappingURL=nestled.umd.min.js.map
